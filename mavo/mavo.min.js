!function(){"use strict";function ee(ie,se,le){return se=void 0===se?1:se,le=le||se+1,1>=le-se?function(){if(arguments.length<=se||"string"===re.type(arguments[se]))return ie.apply(this,arguments);var de,pe=arguments[se];for(var ue in pe){var ce=Array.from(arguments);ce.splice(se,1,ue,pe[ue]),de=ie.apply(this,ce)}return de}:ee(ee(ie,se+1,le),se,le-1)}function te(ie,se,le){var de=ae(le);if("string"===de){var pe=Object.getOwnPropertyDescriptor(se,le);!pe||pe.writable&&pe.configurable&&pe.enumerable&&!pe.get&&!pe.set?ie[le]=se[le]:(delete ie[le],Object.defineProperty(ie,le,pe))}else if("array"===de)le.forEach(function(ce){ce in se&&te(ie,se,ce)});else for(var ue in se)(!le||("regexp"!==de||le.test(ue))&&("function"!==de||le.call(se,ue)))&&te(ie,se,ue);return ie}function ae(ie){if(null===ie)return"null";if(void 0===ie)return"undefined";var se=(Object.prototype.toString.call(ie).match(/^\[object\s+(.*?)\]$/)[1]||"").toLowerCase();return"number"==se&&isNaN(ie)?"nan":se}var re=self.Bliss=te(function(ie,se){return(2!=arguments.length||se)&&ie?"string"===re.type(ie)?(se||document).querySelector(ie):ie||null:null},self.Bliss);te(re,{extend:te,overload:ee,type:ae,property:re.property||"_",sources:{},noop:function(){},$:function(ie,se){return ie instanceof Node||ie instanceof Window?[ie]:2!=arguments.length||se?Array.from("string"==typeof ie?(se||document).querySelectorAll(ie):ie||[]):[]},defined:function(){for(var ie=0;ie<arguments.length;ie++)if(void 0!==arguments[ie])return arguments[ie]},create:function(ie,se){return ie instanceof Node?re.set(ie,se):(1===arguments.length&&("string"===re.type(ie)?se={}:(se=ie,ie=se.tag,se=re.extend({},se,function(le){return"tag"!==le}))),re.set(document.createElement(ie||"div"),se))},each:function(ie,se,le){for(var de in le=le||{},ie)le[de]=se.call(ie,de,ie[de]);return le},ready:function(ie){return ie=ie||document,new Promise(function(se){"loading"===ie.readyState?ie.addEventListener("DOMContentLoaded",function(){se()}):se()})},Class:function(ie){var se,le=["constructor","extends","abstract","static"].concat(Object.keys(re.classProps)),de=ie.hasOwnProperty("constructor")?ie.constructor:re.noop;2==arguments.length?(se=arguments[0],ie=arguments[1]):(se=function(){if(this.constructor.__abstract&&this.constructor===se)throw new Error("Abstract classes cannot be directly instantiated.");se["super"]&&se["super"].apply(this,arguments),de.apply(this,arguments)},se["super"]=ie["extends"]||null,se.prototype=re.extend(Object.create(se["super"]?se["super"].prototype:Object),{constructor:se}),se.prototype["super"]=se["super"]?se["super"].prototype:null,se.__abstract=!!ie.abstract);var pe=function(ce){return this.hasOwnProperty(ce)&&-1===le.indexOf(ce)};if(ie["static"])for(var ue in re.extend(se,ie["static"],pe),re.classProps)ue in ie["static"]&&re.classProps[ue](se,ie["static"][ue]);for(var ue in re.extend(se.prototype,ie,pe),re.classProps)ue in ie&&re.classProps[ue](se.prototype,ie[ue]);return se},classProps:{lazy:ee(function(ie,se,le){return Object.defineProperty(ie,se,{get:function(){var de=le.call(this);return Object.defineProperty(this,se,{value:de,configurable:!0,enumerable:!0,writable:!0}),de},set:function(de){Object.defineProperty(this,se,{value:de,configurable:!0,enumerable:!0,writable:!0})},configurable:!0,enumerable:!0}),ie}),live:ee(function(ie,se,le){return"function"===re.type(le)&&(le={set:le}),Object.defineProperty(ie,se,{get:function(){var de=this["_"+se],pe=le.get&&le.get.call(this,de);return void 0===pe?de:pe},set:function(de){var pe=this["_"+se],ue=le.set&&le.set.call(this,de,pe);this["_"+se]=void 0===ue?de:ue},configurable:le.configurable,enumerable:le.enumerable}),ie})},include:function(){var ie=arguments[arguments.length-1],se=!(2!==arguments.length)&&arguments[0],le=document.createElement("script");return se?Promise.resolve():new Promise(function(de,pe){re.set(le,{async:!0,onload:function(){de(),re.remove(le)},onerror:function(){pe()},src:ie,inside:document.head})})},fetch:function(ie,se){if(!ie)throw new TypeError("URL parameter is mandatory and cannot be "+ie);var le=te({url:new URL(ie,location),data:"",method:"GET",headers:{},xhr:new XMLHttpRequest},se);for(var de in le.method=le.method.toUpperCase(),re.hooks.run("fetch-args",le),"GET"===le.method&&le.data&&(le.url.search+=le.data),document.body.setAttribute("data-loading",le.url),le.xhr.open(le.method,le.url.href,!1!==le.async,le.user,le.password),se)if(de in le.xhr)try{le.xhr[de]=se[de]}catch(ue){self.console&&console.error(ue)}for(var pe in"GET"===le.method||le.headers["Content-type"]||le.headers["Content-Type"]||le.xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded"),le.headers)le.xhr.setRequestHeader(pe,le.headers[pe]);return new Promise(function(ue,ce){le.xhr.onload=function(){document.body.removeAttribute("data-loading"),0===le.xhr.status||200<=le.xhr.status&&300>le.xhr.status||304===le.xhr.status?ue(le.xhr):ce(re.extend(Error(le.xhr.statusText),{xhr:le.xhr,get status(){return this.xhr.status}}))},le.xhr.onerror=function(){document.body.removeAttribute("data-loading"),ce(re.extend(Error("Network Error"),{xhr:le.xhr}))},le.xhr.ontimeout=function(){document.body.removeAttribute("data-loading"),ce(re.extend(Error("Network Timeout"),{xhr:le.xhr}))},le.xhr.send("GET"===le.method?null:le.data)})},value:function(ie){var se="string"!==re.type(ie);return re.$(arguments).slice(+se).reduce(function(le,de){return le&&le[de]},se?ie:self)}}),re.Hooks=new re.Class({add:function(ie,se,le){if("string"==typeof arguments[0])(Array.isArray(ie)?ie:[ie]).forEach(function(de){this[de]=this[de]||[],se&&this[de][le?"unshift":"push"](se)},this);else for(var ie in arguments[0])this.add(ie,arguments[0][ie],arguments[1])},run:function(ie,se){this[ie]=this[ie]||[],this[ie].forEach(function(le){le.call(se&&se.context?se.context:se,se)})}}),re.hooks=new re.Hooks;var ne=re.property;re.Element=function(ie){this.subject=ie,this.data={},this.bliss={}},re.Element.prototype={set:ee(function(ie,se){ie in re.setProps?re.setProps[ie].call(this,se):ie in this?this[ie]=se:this.setAttribute(ie,se)},0),transition:function(ie,se){return se=+se||400,new Promise(function(le){if("transition"in this.style){var pe=re.extend({},this.style,/^transition(Duration|Property)$/);re.style(this,{transitionDuration:(se||400)+"ms",transitionProperty:Object.keys(ie).join(", ")}),re.once(this,"transitionend",function(){clearTimeout(ue),re.style(this,pe),le(this)});var ue=setTimeout(le,se+50,this);re.style(this,ie)}else re.style(this,ie),le(this)}.bind(this))},fire:function(ie,se){var le=document.createEvent("HTMLEvents");return le.initEvent(ie,!0,!0),this.dispatchEvent(re.extend(le,se))},unbind:ee(function(ie,se){(ie||"").split(/\s+/).forEach(function(le){if(ne in this&&(-1<le.indexOf(".")||!se)){le=(le||"").split(".");var de=le[1];le=le[0];var pe=this[ne].bliss.listeners=this[ne].bliss.listeners||{};for(var ue in pe)if(!le||ue===le)for(var ce,he=0;ce=pe[ue][he];he++)de&&de!==ce.className||se&&se!==ce.callback||(this.removeEventListener(ue,ce.callback,ce.capture),he--)}else this.removeEventListener(le,se)},this)},0)},re.setProps={style:function(ie){for(var se in ie)se in this.style?this.style[se]=ie[se]:this.style.setProperty(se,ie[se])},attributes:function(ie){for(var se in ie)this.setAttribute(se,ie[se])},properties:function(ie){re.extend(this,ie)},events:function(ie){if(ie&&ie.addEventListener){var se=this;if(ie[ne]&&ie[ne].bliss){var le=ie[ne].bliss.listeners;for(var de in le)le[de].forEach(function(ge){se.addEventListener(de,ge.callback,ge.capture)})}for(var pe in ie)0===pe.indexOf("on")&&(this[pe]=ie[pe])}else if(1<arguments.length&&"string"===re.type(ie)){var ue=arguments[1],ce=arguments[2];ie.split(/\s+/).forEach(function(ge){this.addEventListener(ge,ue,ce)},this)}else for(var he in ie)re.events(this,he,ie[he])},once:ee(function(ie,se){ie=ie.split(/\s+/);var le=this,de=function(){return ie.forEach(function(pe){le.removeEventListener(pe,de)}),se.apply(le,arguments)};ie.forEach(function(pe){le.addEventListener(pe,de)})},0),delegate:ee(function(ie,se,le){this.addEventListener(ie,function(de){de.target.closest(se)&&le.call(this,de)})},0,2),contents:function(ie){(ie||0===ie)&&(Array.isArray(ie)?ie:[ie]).forEach(function(se){var le=re.type(se);/^(string|number)$/.test(le)?se=document.createTextNode(se+""):"object"===le&&(se=re.create(se)),se instanceof Node&&this.appendChild(se)},this)},inside:function(ie){ie.appendChild(this)},before:function(ie){ie.parentNode.insertBefore(this,ie)},after:function(ie){ie.parentNode.insertBefore(this,ie.nextSibling)},start:function(ie){ie.insertBefore(this,ie.firstChild)},around:function(ie){ie.parentNode&&re.before(this,ie),(/^template$/i.test(this.nodeName)?this.content||this:this).appendChild(ie)}},re.Array=function(ie){this.subject=ie},re.Array.prototype={all:function(ie){var se=$$(arguments).slice(1);return this[ie].apply(this,se)}},re.add=ee(function(ie,se,le,de){le=re.extend({$:!0,element:!0,array:!0},le),"function"==re.type(se)&&(!le.element||ie in re.Element.prototype&&de||(re.Element.prototype[ie]=function(){return this.subject&&re.defined(se.apply(this.subject,arguments),this.subject)}),!le.array||ie in re.Array.prototype&&de||(re.Array.prototype[ie]=function(){var pe=arguments;return this.subject.map(function(ue){return ue&&re.defined(se.apply(ue,pe),ue)})}),le.$&&(re.sources[ie]=re[ie]=se,(le.array||le.element)&&(re[ie]=function(){var pe=[].slice.apply(arguments),ue=pe.shift(),ce=le.array&&Array.isArray(ue)?"Array":"Element";return re[ce].prototype[ie].apply({subject:ue},pe)})))},0),re.add(re.Array.prototype,{element:!1}),re.add(re.Element.prototype),re.add(re.setProps),re.add(re.classProps,{element:!1,array:!1});var oe=document.createElement("_");re.add(re.extend({},HTMLElement.prototype,function(ie){return"function"===re.type(oe[ie])}),null,!0)}(),function(ee){"use strict";if(Bliss&&!Bliss.shy){var te=Bliss.property;if(ee.add({clone:function(){var ie=this.cloneNode(!0),se=ee.$("*",ie).concat(ie);return ee.$("*",this).concat(this).forEach(function(le,de){ee.events(se[de],le),se[de]._.data=ee.extend({},le._.data)}),ie}},{array:!1}),Object.defineProperty(Node.prototype,te,{get:function ie(){return Object.defineProperty(Node.prototype,te,{get:void 0}),Object.defineProperty(this,te,{value:new ee.Element(this)}),Object.defineProperty(Node.prototype,te,{get:ie}),this[te]},configurable:!0}),Object.defineProperty(Array.prototype,te,{get:function(){return Object.defineProperty(this,te,{value:new ee.Array(this)}),this[te]},configurable:!0}),self.EventTarget&&"addEventListener"in EventTarget.prototype){var ae=EventTarget.prototype.addEventListener,re=EventTarget.prototype.removeEventListener,ne=function(ie,se,le){return le.callback===ie&&le.capture==se},oe=function(){return!ne.apply(this,arguments)};EventTarget.prototype.addEventListener=function(ie,se,le){if(this&&this[te]&&this[te].bliss&&se){var de=this[te].bliss.listeners=this[te].bliss.listeners||{};if(-1<ie.indexOf(".")){ie=ie.split(".");var pe=ie[1];ie=ie[0]}de[ie]=de[ie]||[],0===de[ie].filter(ne.bind(null,se,le)).length&&de[ie].push({callback:se,capture:le,className:pe})}return ae.call(this,ie,se,le)},EventTarget.prototype.removeEventListener=function(ie,se,le){if(this&&this[te]&&this[te].bliss&&se){var de=this[te].bliss.listeners=this[te].bliss.listeners||{};de[ie]&&(de[ie]=de[ie].filter(oe.bind(null,se,le)))}return re.call(this,ie,se,le)}}self.$=self.$||ee,self.$$=self.$$||ee.$}}(Bliss),!function(ee){"use strict";var te="Compound",re="MemberExpression",ne="Literal",ce=46,he=44,fe=40,ye=41,be=91,xe=93,Ae=function(Re,$e){var qe=new Error(Re+" at character "+$e);throw qe.index=$e,qe.description=Re,qe},Ne=!0,Pe={"-":Ne,"!":Ne,"~":Ne,"+":Ne},Le={"||":1,"&&":2,"|":3,"^":4,"&":5,"==":6,"!=":6,"===":6,"!==":6,"<":7,">":7,"<=":7,">=":7,"<<":8,">>":8,">>>":8,"+":9,"-":9,"*":10,"/":10,"%":10},we=function(Re){var $e,qe=0;for(var Ge in Re)($e=Ge.length)>qe&&Re.hasOwnProperty(Ge)&&(qe=$e);return qe},Oe=we(Pe),Te=we(Le),Se={"true":!0,"false":!1,"null":null},De=function(Re){return Le[Re]||0},Ve=function(Re,$e,qe){var Ge="||"===Re||"&&"===Re?"LogicalExpression":"BinaryExpression";return{type:Ge,operator:Re,left:$e,right:qe}},je=function(Re){return 48<=Re&&57>=Re},ze=function(Re){return 36===Re||95===Re||65<=Re&&90>=Re||97<=Re&&122>=Re||128<=Re&&!Le[String.fromCharCode(Re)]},Be=function(Re){return 36===Re||95===Re||65<=Re&&90>=Re||97<=Re&&122>=Re||48<=Re&&57>=Re||128<=Re&&!Le[String.fromCharCode(Re)]},Ue=function(Re){for(var $e,qe,Ge=0,Me=Re.charAt,He=Re.charCodeAt,Fe=function(dt){return Me.call(Re,dt)},Ye=function(dt){return He.call(Re,dt)},We=Re.length,Je=function(){for(var dt=Ye(Ge);32===dt||9===dt;)dt=Ye(++Ge)},Ke=function(){var dt,pt,ut=Xe();return Je(),Ye(Ge)===63?(Ge++,dt=Ke(),dt||Ae("Expected expression",Ge),Je(),Ye(Ge)===58?(Ge++,pt=Ke(),pt||Ae("Expected expression",Ge),{type:"ConditionalExpression",test:ut,consequent:dt,alternate:pt}):void Ae("Expected :",Ge)):ut},Ze=function(){Je();for(var dt=Re.substr(Ge,Te),pt=dt.length;0<pt;){if(Le.hasOwnProperty(dt))return Ge+=pt,dt;dt=dt.substr(0,--pt)}return!1},Xe=function(){var dt,pt,ut,ct,mt,ht,gt,vt;if(ht=Qe(),pt=Ze(),!pt)return ht;for(mt={value:pt,prec:De(pt)},gt=Qe(),gt||Ae("Expected expression after "+pt,Ge),ct=[ht,mt,gt];(pt=Ze())&&(ut=De(pt),0!==ut);){for(mt={value:pt,prec:ut};2<ct.length&&ut<=ct[ct.length-2].prec;)gt=ct.pop(),pt=ct.pop().value,ht=ct.pop(),dt=Ve(pt,ht,gt),ct.push(dt);dt=Qe(),dt||Ae("Expected expression after "+pt,Ge),ct.push(mt,dt)}for(vt=ct.length-1,dt=ct[vt];1<vt;)dt=Ve(ct[vt-1].value,ct[vt-2],dt),vt-=2;return dt},Qe=function(){var dt,pt,ut;if(Je(),dt=Ye(Ge),je(dt)||dt===ce)return tt();if(dt===39||dt===34)return at();if(ze(dt)||dt===fe)return ot();if(dt===be)return st();for(pt=Re.substr(Ge,Oe),ut=pt.length;0<ut;){if(Pe.hasOwnProperty(pt))return Ge+=ut,{type:"UnaryExpression",operator:pt,argument:Qe(),prefix:!0};pt=pt.substr(0,--ut)}return!1},tt=function(){for(var dt,pt,ut="";je(Ye(Ge));)ut+=Fe(Ge++);if(Ye(Ge)===ce)for(ut+=Fe(Ge++);je(Ye(Ge));)ut+=Fe(Ge++);if(dt=Fe(Ge),"e"===dt||"E"===dt){for(ut+=Fe(Ge++),dt=Fe(Ge),"+"!==dt&&"-"!==dt||(ut+=Fe(Ge++));je(Ye(Ge));)ut+=Fe(Ge++);je(Ye(Ge-1))||Ae("Expected exponent ("+ut+Fe(Ge)+")",Ge)}return pt=Ye(Ge),ze(pt)?Ae("Variable names cannot start with a number ("+ut+Fe(Ge)+")",Ge):pt===ce&&Ae("Unexpected period",Ge),{type:ne,value:parseFloat(ut),raw:ut}},at=function(){for(var dt,pt="",ut=Fe(Ge++),ct=!1;Ge<We;){if(dt=Fe(Ge++),dt===ut){ct=!0;break}if("\\"===dt)switch(dt=Fe(Ge++)){case"n":pt+="\n";break;case"r":pt+="\r";break;case"t":pt+="\t";break;case"b":pt+="\b";break;case"f":pt+="\f";break;case"v":pt+="\x0B";break;default:pt+="\\"+dt;}else pt+=dt}return ct||Ae("Unclosed quote after \""+pt+"\"",Ge),{type:ne,value:pt,raw:ut+pt+ut}},rt=function(){var dt,pt=Ye(Ge),ut=Ge;for(ze(pt)?Ge++:Ae("Unexpected "+Fe(Ge),Ge);Ge<We&&(pt=Ye(Ge),Be(pt));)Ge++;return dt=Re.slice(ut,Ge),Se.hasOwnProperty(dt)?{type:ne,value:Se[dt],raw:dt}:dt==="this"?{type:"ThisExpression"}:{type:"Identifier",name:dt}},nt=function(dt){for(var pt,ut,ct=[],mt=!1;Ge<We;){if(Je(),pt=Ye(Ge),pt===dt){mt=!0,Ge++;break}pt===he?Ge++:(ut=Ke(),ut&&ut.type!==te||Ae("Expected comma",Ge),ct.push(ut))}return mt||Ae("Expected "+String.fromCharCode(dt),Ge),ct},ot=function(){var dt,pt;for(dt=Ye(Ge),pt=dt===fe?it():rt(),Je(),dt=Ye(Ge);dt===ce||dt===be||dt===fe;)Ge++,dt===ce?(Je(),pt={type:re,computed:!1,object:pt,property:rt()}):dt===be?(pt={type:re,computed:!0,object:pt,property:Ke()},Je(),dt=Ye(Ge),dt!=xe&&Ae("Unclosed [",Ge),Ge++):dt==fe&&(pt={type:"CallExpression",arguments:nt(ye),callee:pt}),Je(),dt=Ye(Ge);return pt},it=function(){Ge++;var dt=Ke();return Je(),Ye(Ge)===ye?(Ge++,dt):void Ae("Unclosed (",Ge)},st=function(){return Ge++,{type:"ArrayExpression",elements:nt(xe)}},lt=[];Ge<We;)$e=Ye(Ge),$e===59||$e===he?Ge++:(qe=Ke())?lt.push(qe):Ge<We&&Ae("Unexpected \""+Fe(Ge)+"\"",Ge);return 1===lt.length?lt[0]:{type:te,body:lt}};if(Ue.version="0.3.1",Ue.toString=function(){return"JavaScript Expression Parser (JSEP) v"+Ue.version},Ue.addUnaryOp=function(Re){return Oe=Math.max(Re.length,Oe),Pe[Re]=Ne,this},Ue.addBinaryOp=function(Re,$e){return Te=Math.max(Re.length,Te),Le[Re]=$e,this},Ue.addLiteral=function(Re,$e){return Se[Re]=$e,this},Ue.removeUnaryOp=function(Re){return delete Pe[Re],Re.length===Oe&&(Oe=we(Pe)),this},Ue.removeBinaryOp=function(Re){return delete Le[Re],Re.length===Te&&(Te=we(Le)),this},Ue.removeLiteral=function(Re){return delete Se[Re],this},"undefined"==typeof exports){var _e=ee.jsep;ee.jsep=Ue,Ue.noConflict=function(){return ee.jsep===Ue&&(ee.jsep=_e),Ue}}else"undefined"!=typeof module&&module.exports?exports=module.exports=Ue:exports.parse=Ue}(this),function(){function ee(re,ne){return re instanceof Node||re instanceof Window?[re]:[].slice.call("string"==typeof re?(ne||document).querySelectorAll(re):re||[])}if(self.Element&&(Element.prototype.matches||(Element.prototype.matches=Element.prototype.webkitMatchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||null),!!Element.prototype.matches)){var te=self.Stretchy={selectors:{base:"textarea, select:not([size]), input:not([type]), input[type=\""+"text url email tel".split(" ").join("\"], input[type=\"")+"\"]",filter:"*"},script:document.currentScript||ee("script").pop(),resize:function(re){if(te.resizes(re)){var ne=getComputedStyle(re),oe=0;if(!re.value&&re.placeholder){re.value=re.placeholder}var se=re.nodeName.toLowerCase();if("textarea"==se)re.style.height="0","border-box"==ne.boxSizing?oe=re.offsetHeight:"content-box"==ne.boxSizing&&(oe=-re.clientHeight),re.style.height=re.scrollHeight+oe+"px";else if("input"==se){if(re.style.width="1000px",re.offsetWidth){re.style.width="0","border-box"==ne.boxSizing?oe=re.offsetWidth:"padding-box"==ne.boxSizing&&(oe=re.clientWidth),re.scrollLeft=1e10;var le=Math.max(re.scrollLeft+oe,re.scrollWidth-re.clientWidth);re.style.width=le+"px"}else re.style.width=re.value.length+1+"ch";}else if("select"==se){var de=0<re.selectedIndex?re.selectedIndex:0,pe=document.createElement("_");pe.textContent=re.options[de].textContent,re.parentNode.insertBefore(pe,re.nextSibling);var ue;for(var ce in ne){var he=ne[ce];/^(width|webkitLogicalWidth|length)$/.test(ce)||"string"!=typeof he||(pe.style[ce]=he,/appearance$/i.test(ce)&&(ue=ce))}pe.style.width="",0<pe.offsetWidth&&(re.style.width=pe.offsetWidth+"px",(!ne[ue]||"none"!==ne[ue])&&(re.style.width="calc("+re.style.width+" + 2em)")),pe.parentNode.removeChild(pe),pe=null}re.value=""}},resizeAll:function(re){ee(re||te.selectors.base).forEach(function(ne){te.resize(ne)})},active:!0,resizes:function(re){return re&&re.parentNode&&re.matches&&re.matches(te.selectors.base)&&re.matches(te.selectors.filter)},init:function(){te.selectors.filter=te.script.getAttribute("data-filter")||(ee("[data-stretchy-filter]").pop()||document.body).getAttribute("data-stretchy-filter")||Stretchy.selectors.filter||"*",te.resizeAll()},$$:ee};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",te.init):te.init();var ae=function(re){te.active&&te.resize(re.target)};document.documentElement.addEventListener("input",ae),document.documentElement.addEventListener("change",ae),self.MutationObserver&&new MutationObserver(function(re){te.active&&re.forEach(function(ne){"childList"==ne.type&&Stretchy.resizeAll(ne.addedNodes)})}).observe(document.documentElement,{childList:!0,subtree:!0})}}(),function(ee,te){var ae=self.Mavo=ee.Class({constructor:function(re){this.treeBuilt=Mavo.defer(),this.element=re,this.index=ae.length+1,Object.defineProperty(ae.all,this.index-1,{value:this});var ne=ae.attributes.map(pe=>`[data-${pe}]`).join(", ");if([this.element,...te(ne,this.element)].forEach(pe=>{for(let ue of ae.attributes){let ce=pe.getAttribute("data-"+ue);null!==ce&&pe.setAttribute(ue,ce)}}),this.id=Mavo.getAttribute(this.element,"mv-app","id")||`mavo${this.index}`,this.id in ae.all){for(var oe=2;this.id+oe in ae.all;oe++);this.id+=oe}ae.all[this.id]=this,this.element.setAttribute("mv-app",this.id),this.autoEdit=this.element.classList.contains("mv-autoedit"),this.autoSave=this.element.hasAttribute("mv-autosave"),this.autoSaveDelay=1e3*(this.element.getAttribute("mv-autosave")||3),this.element.setAttribute("typeof",""),Mavo.hooks.run("init-start",this);for(var re of te(ae.selectors.primitive,this.element)){var ie=ee(`${ae.selectors.not(ae.selectors.formControl)}, ${ae.selectors.property}`,re);if(ie){var se=Mavo.Primitive.getConfig(re),le=Mavo.is("multiple",re);!le&&(se.attribute||se.hasChildren)||re.setAttribute("typeof","")}}this.expressions=new Mavo.Expressions(this),Mavo.hooks.run("init-tree-before",this),this.root=new Mavo.Group(this.element,this),this.treeBuilt.resolve(),Mavo.hooks.run("init-tree-after",this),this.permissions=new Mavo.Permissions;var de=["source","storage","init"];for(let pe of de)this.updateBackend(pe);this.backendObserver=new Mavo.Observer(this.element,de.map(pe=>"mv-"+pe),pe=>{var ue={},ce=pe.map(he=>{var ge=he.attributeName.replace(/^mv-/,"");return ue[ge]=this.updateBackend(ge),ge});ue.source?this.load():!this.source&&(ue.storage||ue.init&&!this.root.data)&&this.load()}),this.permissions.can("login",()=>{("login"in Mavo.Functions.$url&&1==this.index||this.id+"-login"in Mavo.Functions.$url)&&this.primaryBackend.login()}),this.element.addEventListener("mavo:login.mavo",pe=>{pe.backend!=(this.source||this.storage)||this.root.data||this.unsavedChanges||this.load()}),this.bar=new Mavo.UI.Bar(this),ee("summary [property]:not([typeof])")&&this.element.addEventListener("click",pe=>{pe.target!=document.activeElement&&pe.preventDefault()}),this.needsEdit=this.some(pe=>pe!=this.root&&!pe.modes&&"read"==pe.mode),this.setUnsavedChanges(!1),this.permissions.onchange(({action:pe,value:ue})=>{var ce=this.element.getAttribute("mv-permissions")||"";ce=ce.trim().split(/\s+/).filter(he=>he!=pe),ue&&ce.push(pe),this.element.setAttribute("mv-permissions",ce.join(" "))}),this.needsEdit&&this.permissions.can(["edit","add","delete"],()=>{this.modeObserver=new Mavo.Observer(this.element,"mv-mode",pe=>{for(let ue of pe){let ce=ue.target;nodeloop:for(let he of ae.Node.children(ce)){let ve,ge=he.mode;if(he.element==ce)ve=he.element.getAttribute("mv-mode"),he.modes=ve;else{if(he.modes)continue nodeloop;ve=ae.getStyle(he.element.parentNode,"--mv-mode")}he.mode=ve,ge!=he.mode&&he["edit"==he.mode?"edit":"done"]()}}},{subtree:!0}),this.autoEdit&&this.edit()},()=>{this.modeObserver&&this.modeObserver.destroy()}),this.storage||this.source?this.permissions.can("read",()=>this.load()):ee.fire(this.element,"mavo:load"),this.permissions.can("save",()=>{this.autoSave&&this.element.addEventListener("mavo:load.mavo:autosave",()=>{var ue=ae.debounce(()=>{this.save()},this.autoSaveDelay),ce=he=>{he.node.saved&&ue()};requestAnimationFrame(()=>{this.permissions.can("save",()=>{this.element.addEventListener("mavo:datachange.mavo:autosave",ce)},()=>{this.element.removeEventListener("mavo:datachange.mavo:autosave",ce)})})}),this.element.addEventListener("keydown.mavo:save",pe=>{83==pe.keyCode&&pe[ae.superKey]&&(pe.preventDefault(),this.save())})},()=>{ee.unbind(this.element,".mavo:save .mavo:autosave")}),Mavo.hooks.run("init-end",this)},get editing(){return this.root.editing},getData:function(){return this.root.getData()},toJSON:function(){return ae.toJSON(this.getData())},message:function(re,ne){return new ae.UI.Message(this,re,ne)},error:function(re,...ne){this.message(re,{classes:"mv-error",dismiss:["button","timeout"]}),0<ne.length&&console.log(`%c${this.id}: ${re}`,"color: red; font-weight: bold",...ne)},render:function(re){this.expressions.active=!1;var ne={context:this,data:re};ae.hooks.run("render-start",ne),ne.data&&this.root.render(ne.data),this.unsavedChanges=!1,this.expressions.active=!0,requestAnimationFrame(()=>this.expressions.update()),ae.hooks.run("render-end",ne)},clear:function(){confirm("This will delete all your data. Are you sure?")&&this.store(null).then(()=>this.root.clear())},edit:function(){this.root.edit(),ee.events(this.element,"mouseenter.mavo:edit mouseleave.mavo:edit",re=>{if(re.target.matches(ae.selectors.multiple)){re.target.classList.remove("mv-has-hovered-item");var ne=re.target.parentNode.closest(ae.selectors.multiple);ne&&ne.classList.toggle("mv-has-hovered-item","mouseenter"==re.type)}},!0),this.setUnsavedChanges()},setUnsavedChanges:function(re){var ne=!!re;return re||this.walk(oe=>{if(oe.unsavedChanges)return ne=!0,!1===re&&(oe.unsavedChanges=!1),!1}),this.unsavedChanges=ne},done:function(){this.root.done(),ee.unbind(this.element,".mavo:edit"),this.unsavedChanges=!1},updateBackend:function(re){var oe,ne=this[re];1==this.index&&(oe=ae.Functions.$url[re]),oe||(oe=ae.Functions.$url[`${this.id}-${re}`]||this.element.getAttribute("mv-"+re)||null),oe&&(oe=oe.trim(),"none"==oe&&(oe=null)),!oe||ne&&ne.equals(oe)?!oe&&(this[re]=null):this[re]=oe=ae.Backend.create(oe,{mavo:this,format:this.element.getAttribute("mv-format-"+re)||this.element.getAttribute("mv-format")});var ie=oe?!oe.equals(ne):!!ne;if(ie){this.storage||this.source||!this.init||(this.source=this.init,this.init=null);var se=this.storage?this.storage.permissions:new Mavo.Permissions({edit:!0,save:!1});se.parent=this.source&&this.source.permissions,this.permissions.parent=se,this.primaryBackend=this.storage||this.source}return ie},load:function(){var re=this.source||this.storage;return re?(this.inProgress="Loading",re.ready.then(()=>re.load()).catch(ne=>{return this.init&&this.init!=re?(re=this.init,this.init.ready.then(()=>this.init.load())):Promise.reject(ne)}).catch(ne=>{if(ne){var oe=ne instanceof XMLHttpRequest?ne:ne.xhr;if(oe&&404==oe.status)this.render(null);else{var ie="Problem loading data";oe&&(ie+=oe.status?`: HTTP error ${ne.status}: ${ne.statusText}`:": Can\u2019t connect to the Internet"),this.error(ie,ne)}}return null}).then(ne=>this.render(ne)).then(()=>{this.inProgress=!1,ee.fire(this.element,"mavo:load")})):Promise.resolve()},store:function(){return this.storage?(this.inProgress="Saving",this.storage.login().then(()=>this.storage.store(this.getData())).catch(re=>{if(re){var ne="Problem saving data";re instanceof XMLHttpRequest&&(ne+=re.status?`: HTTP error ${re.status}: ${re.statusText}`:": Can\u2019t connect to the Internet"),this.error(ne,re)}return null}).then(re=>{return this.inProgress=!1,re})):Promise.resolve()},upload:function(re,ne="images/"+re.name){return this.uploadBackend?(this.inProgress="Uploading",this.uploadBackend.upload(re,ne).then(oe=>{return this.inProgress=!1,oe}).catch(oe=>{return this.error("Error uploading file",oe),this.inProgress=!1,null})):Promise.reject()},save:function(){return this.store().then(re=>{re&&(ee.fire(this.element,"mavo:save",re),this.lastSaved=Date.now(),this.root.save(),this.unsavedChanges=!1)})},walk:function(re){return this.root.walk(re)},some:function(re){return!this.walk((ne,oe)=>{var ie=re(ne,oe);if(!0===ie)return!1})},live:{inProgress:function(re){ee.toggleAttribute(this.element,"mv-progress",re,re)},unsavedChanges:function(re){this.element.classList.toggle("mv-unsaved-changes",re)},needsEdit:function(re){this.bar.toggle("edit",re)},storage:function(re){if(re!==this._storage&&!re){var ne=new Mavo.Permissions({edit:!0,save:!1});ne.parent=this.permissions.parent,this.permissions.parent=ne}},primaryBackend:function(re){if(re=re||null,re!=this._primaryBackend)return re?this.element.style.setProperty("--mv-backend",`"${re.id}"`):this.element.style.removeProperty("--mv-backend"),re},uploadBackend:{get:function(){if(this.storage&&this.storage.upload)return this.storage}}},static:{all:{},get length(){return Object.keys(ae.all).length},get:function(re){if(re instanceof Element){for(var ne in ae.all)if(ae.all[ne].element==re)return ae.all[ne];return null}var ne="number"==typeof re?Object.keys(ae.all)[re]:re;return ae.all[ne]||null},superKey:0===navigator.platform.indexOf("Mac")?"metaKey":"ctrlKey",base:"about:"==location.protocol?document.currentScript?document.currentScript.src:"http://mavo.io":location,dependencies:[],init:function(re=document){return te(ae.selectors.init,re).filter(ne=>!ae.get(ne)).map(ne=>new ae(ne))},UI:{},hooks:new ee.Hooks,attributes:["mv-app","mv-storage","mv-source","mv-init","mv-path","mv-format","mv-attribute","mv-default","mv-mode","mv-edit","mv-permisssions","mv-rel"]}});{let re=ae.selectors={init:".mv-app, [mv-app], [data-mv-app]",property:"[property], [itemprop]",specificProperty:de=>`[property=${de}], [itemprop=${de}]`,group:"[typeof], [itemscope], [itemtype], [mv-group]",multiple:"[mv-multiple]",formControl:"input, select, option, textarea",ui:".mv-ui",container:{tr:"table",option:"select"}},ne=re.arr=de=>de.split(/\s*,\s*/g),oe=re.not=de=>ne(de).map(pe=>`:not(${pe})`).join(""),ie=re.or=(de,pe)=>de+", "+pe,se=re.and=(de,pe)=>{var ue=[],ce=ne(pe);return ne(de).forEach(he=>ue.push(...ce.map(ge=>he+ge))),ue.join(", ")},le=re.andNot=(de,pe)=>se(de,oe(pe));ee.extend(ae.selectors,{primitive:le(re.property,re.group),rootGroup:le(re.group,re.property),output:ie(re.specificProperty("output"),".mv-output")})}requestAnimationFrame(()=>{var re=Array.from&&window.Intl&&document.documentElement.closest&&self.URL&&"searchParams"in URL.prototype;ae.dependencies.push(ee.ready(),ae.Plugins.load(),ee.include(re,"https://cdn.polyfill.io/v2/polyfill.min.js?features=blissfuljs,Intl.~locale.en")),ae.ready=ae.all(ae.dependencies),ae.inited=ae.ready.catch(console.error).then(()=>Mavo.init())}),Stretchy.selectors.filter=".mv-editor:not([property]), .mv-autosize"}(Bliss,Bliss.$),function(ee,te){function ae(ne,oe){for(ne="mv-"+ne+"-within",te("."+ne).forEach(ie=>ie.classList.remove(ne));oe&&oe.classList;)oe.classList.add(ne),oe=oe.parentNode}var re=ee.extend(Mavo,{load:(ne,oe=document.currentScript?document.currentScript.src:location)=>{if(re.loaded=re.loaded||new Set,!re.loaded.has(ne+""))return ne=new URL(ne,oe),/\.css$/.test(ne.pathname)?(ee.create("link",{href:ne,rel:"stylesheet",inside:document.head}),Promise.resolve()):ee.include(ne)},readFile:(ne,oe="DataURL")=>{var ie=new FileReader;return new Promise((se,le)=>{ie.onload=()=>se(ie.result),ie.onerror=ie.onabort=le,ie["readAs"+oe](ne)})},toJSON:ne=>{return null===ne?"":"string"==typeof ne?ne:JSON.stringify(ne,null,"\t")},toArray:ne=>{return ne===void 0?[]:Array.isArray(ne)?ne:[ne]},delete:(ne,oe)=>{var ie=ne&&ne.indexOf(oe);-1<ie&&ne.splice(ie,1)},hasIntersection:(ne,oe)=>ne&&oe&&!ne.every(ie=>-1==oe.indexOf(ie)),flatten:ne=>{return Array.isArray(ne)?ne.reduce((oe,ie)=>re.toArray(oe).concat(re.flatten(ie)),[]):[ne]},pushUnique:(ne,oe)=>{-1===ne.indexOf(oe)&&ne.push(oe)},is:function(ne,...oe){for(let ie of oe)if(ie&&ie.matches&&ie.matches(re.selectors[ne]))return!0;return!1},getStyle:(ne,oe)=>ne&&getComputedStyle(ne).getPropertyValue(oe).trim(),data:function(ne,oe,ie){return 2==arguments.length?ee.value(ne,"_","data","mavo",oe):(ne._.data.mavo=ne._.data.mavo||{},ne._.data.mavo[oe]=ie)},revocably:{add:function(ne,oe){var ie=re.revocably.isRemoved(ne);return ie&&ie.parentNode?ie.parentNode.replaceChild(ne,ie):ne&&oe&&!ne.parentNode&&oe.appendChild(ne),ie},remove:function(ne,oe){if(ne){var ie=re.data(ne,"commentstub");return ie||(oe=oe||ne.id||ne.className||ne.nodeName,ie=re.data(ne,"commentstub",document.createComment(oe))),ne.parentNode&&ne.parentNode.replaceChild(ie,ne),ie}},isRemoved:function(ne){if(!ne||ne.parentNode)return!1;var oe=re.data(ne,"commentstub");return oe&&oe.parentNode&&oe}},inViewport:ne=>{var oe=ne.getBoundingClientRect();return(0<=oe.bottom&&oe.bottom<=innerHeight||0<=oe.top&&oe.top<=innerHeight)&&(0<=oe.right&&oe.right<=innerWidth||0<=oe.left&&oe.left<=innerWidth)},scrollIntoViewIfNeeded:ne=>{ne&&!Mavo.inViewport(ne)&&ne.scrollIntoView({behavior:"smooth"})},getAttribute:function(ne,...oe){for(let se,le,ie=0;se=oe[ie];ie++)if(le=ne.getAttribute(se),le)return le;return null},subset:function(ne,oe,ie){if(3==arguments.length){if(oe.length){var se=ee.value(ne,...oe.slice(0,-1));return se[oe[oe.length-1]]=ie,ne}return ie}return"object"==typeof ne&&oe&&oe.length?oe.reduce((le,de,pe)=>{if(le&&de in le)return le[de];if(Array.isArray(le)&&isNaN(de))for(var ue=0;ue<le.length;ue++)if(le[ue]&&le[ue].id==de)return oe[pe]=ue,le[ue];return le},ne):ne},clone:function(ne){var oe=new WeakSet;return JSON.parse(JSON.stringify(ne,(ie,se)=>{if("object"==typeof se&&null!==se){if(oe.has(se))return;oe.add(se)}return se}))},debounce:function(ne,oe){if(!oe)return ne;var se,ie=null;return function(){var le=this,de=arguments;se=function(){ne.apply(le,de),removeEventListener("beforeunload",se)},clearTimeout(ie),ie=setTimeout(se,oe),addEventListener("beforeunload",se)}},escapeRegExp:ne=>ne.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),Observer:ee.Class({constructor:function(ne,oe,ie,se={}){ie instanceof MutationObserver&&(this.observer=ie),this.observer=this.observer||new MutationObserver(ie),this.element=ne,this.callback=ie,this.attribute=oe,this.options=ee.extend({},se),oe&&ee.extend(this.options,{attributes:!0,attributeFilter:"all"==this.attribute?void 0:Mavo.toArray(this.attribute),attributeOldValue:!!se.oldValue}),this.attribute&&"all"!=this.attribute||ee.extend(this.options,{characterData:!0,childList:!0,subtree:!0,characterDataOldValue:!!se.oldValue}),this.run()},stop:function(){return this.observer.disconnect(),this.running=!1,this},run:function(){return this.observer&&(this.observer.observe(this.element,this.options),this.running=!0),this},sneak:function(ne){if(this.running){this.stop();var oe=ne();this.run()}else var oe=ne();return oe},destroy:function(){this.observer.disconnect(),this.observer=this.element=null},static:{sneak:function(ne,oe){return ne?ne.sneak(oe):oe()}}}),defer:function(ne){var oe,ie,se=new Promise((le,de)=>{ne&&ne(le,de),oe=le,ie=de});return se.resolve=le=>{return oe(le),se},se.reject=le=>{return ie(le),se},se},all:function(ne){for(let oe of ne)"promise"==ee.type(oe)&&(oe=oe.catch(ie=>ie));return Promise.all(ne).then(oe=>{return ne.length==oe.length?oe:re.all(ne)})},rr:function(ne){return ne(),ne}});ee.add("toggleAttribute",function(ne,oe,ie=null!==oe){ie?this.setAttribute(ne,oe):this.removeAttribute(ne)}),ee.proxy=ee.classProps.proxy=ee.overload(function(ne,oe,ie){return Object.defineProperty(ne,oe,{get:function(){return this[ie][oe]},set:function(se){this[ie][oe]=se},configurable:!0,enumerable:!0}),ne}),ee.classProps.propagated=function(ne,oe){Mavo.toArray(oe).forEach(ie=>{var se=ne[ie];ne[ie]=function(){var le=se&&se.apply(this,arguments);this.propagate&&!1!==le&&this.propagate(ie)}})};document.addEventListener("focus",ne=>{ae("focus",ne.target)},!0),document.addEventListener("blur",()=>{ae("focus",null)},!0),addEventListener("hashchange",()=>{ae("target",ee(location.hash))}),document.documentElement.addEventListener("mavo:datachange",()=>{ae("target",ee(location.hash))}),ae("focus",document.activeElement===document.body?null:document.activeElement)}(Bliss,Bliss.$),function(ee){Mavo.attributes.push("mv-plugins");var te=Mavo.Plugins={loaded:{},load:function(){te.plugins=new Set;for(let ae of $$("[mv-plugins]")){let re=ae.getAttribute("mv-plugins").trim().split(/\s+/);for(let ne of re)te.plugins.add(ne)}return te.plugins.size?ee.fetch(te.url+"/plugins.json",{responseType:"json"}).then(ae=>{return Mavo.all(ae.response.plugin.filter(re=>te.plugins.has(re.id)).map(re=>{if(re.repo)var ne=`https://raw.githubusercontent.com/${re.repo}/`;else var ne=`${te.url}/${re.id}/`;var oe=`${ne}mavo-${re.id}.js`;return ee.include(te.loaded[re.id],oe)}))}):Promise.resolve()},register:function(ae){if(!(ae.name&&te.loaded[ae.name])){for(let ie in Mavo.hooks.add(ae.hooks),ae.extend){let se="Mavo"==ie?Mavo:Mavo[ie];"function"===ee.type(se)?ee.Class(se,ae.extend[ie]):ee.extend(se,ae.extend[ie])}var re=[];if(ae.ready&&re.push(ae.ready),ae.dependencies){var ne=document.currentScript?document.currentScript.src:location,oe=ae.dependencies.map(ie=>Mavo.load(ie,ne));re.push(...oe)}re.length&&Mavo.dependencies.push(...re),ae.name&&(te.loaded[ae.name]=ae),ae.init&&Promise.all(re).then(()=>ae.init())}},url:"https://plugins.mavo.io/"}}(Bliss),function(ee){Mavo.attributes.push("mv-bar");var ae=Mavo.UI.Bar=ee.Class({constructor:function(re){this.mavo=re,this.element=ee(".mv-bar",this.mavo.element)||ee.create({className:"mv-bar mv-ui",start:this.mavo.element,innerHTML:"<button>&nbsp;</button>"}),this.element.classList.contains("mv-compact")&&(this.noResize=!0),this.order=this.mavo.element.getAttribute("mv-bar")||this.element.getAttribute("mv-bar"),this.order=this.order?"none"==this.order?[]:this.order.split(/\s+/):Object.keys(ae.controls),this.order=this.order.filter(se=>ae.controls[se]),this.order.length&&(this.targetHeight=this.element.offsetHeight),this.element.innerHTML="";for(let se of this.order){let le=ae.controls[se];if(le.create)this[se]=le.create.call(this.mavo);else{var ne=le.label||Mavo.Functions.readable(se);this[se]=ee.create("button",{className:`mv-${se}`,textContent:ne,title:ne})}for(var oe in this.add(se),le.permission?this.permissions.can(le.permission,()=>{this.toggle(se,!le.condition||le.condition.call(this.mavo))},()=>{this.remove(se)}):le.condition&&!le.condition.call(this.mavo)&&this.remove(se),le.events)ee.events(this[se],oe,le.events[oe].bind(this.mavo));le.action&&ee.delegate(this.element,"click",".mv-"+se,()=>{(!le.permission||this.permissions.is(le.permission))&&le.action.call(this.mavo)})}if(this.order.length&&!this.noResize&&(this.resize(),self.ResizeObserver)){var ie=null;this.resizeObserver=new ResizeObserver(se=>{var le=se[se.length-1].contentRect;ie&&ie.width==le.width&&ie.height==le.height||(this.resize(),ie=le)}),this.resizeObserver.observe(this.element)}},resize:function(){return this.targetHeight?void(this.resizeObserver&&this.resizeObserver.disconnect(),this.element.classList.remove("mv-compact","mv-tiny"),this.element.offsetHeight>1.5*this.targetHeight&&(this.element.classList.add("mv-compact"),this.element.offsetHeight>1.2*this.targetHeight&&this.element.classList.add("mv-tiny")),this.resizeObserver&&this.resizeObserver.observe(this.element)):void(this.targetHeight=this.element.offsetHeight)},add:function(re){var ne=ae.controls[re];ne.prepare&&ne.prepare.call(this.mavo),Mavo.revocably.add(this[re],this.element),this.resizeObserver||this.noResize||requestAnimationFrame(()=>this.resize())},remove:function(re){var ne=ae.controls[re];Mavo.revocably.remove(this[re],"mv-"+re),ne.cleanup&&ne.cleanup.call(this.mavo),this.resizeObserver||this.noResize||requestAnimationFrame(()=>this.resize())},toggle:function(re,ne){return this[ne?"add":"remove"](re)},proxy:{permissions:"mavo"},static:{controls:{status:{create:function(){var re=ee.create({className:"mv-status"});return re},prepare:function(){var re=this.primaryBackend;if(re&&re.user){var ne=re.user,oe=ne.name||"";ne.avatar&&(oe=`<img class="mv-avatar" src="${ne.avatar}" /> ${oe}`),ne.url&&(oe=`<a href="${ne.url}" target="_blank">${oe}</a>`),this.bar.status.innerHTML=oe}},permission:"logout"},edit:{action:function(){this.editing?this.done():this.edit()},permission:["edit","add","delete"],cleanup:function(){this.editing&&this.done()}},save:{action:function(){this.save()},events:{"mouseenter focus":function(){this.element.classList.add("mv-highlight-unsaved")},"mouseleave blur":function(){this.element.classList.remove("mv-highlight-unsaved")}},permission:"save",condition:function(){return!this.autoSave||0<this.autoSaveDelay}},clear:{action:function(){this.clear()},permission:"delete"},login:{action:function(){this.primaryBackend.login()},permission:"login"},logout:{action:function(){this.primaryBackend.logout()},permission:"logout"}}}})}(Bliss,Bliss.$),function(ee){Mavo.UI.Message=ee.Class({constructor:function(re,ne,oe){if(this.mavo=re,this.message=ne,this.closed=Mavo.defer(),this.element=ee.create({className:"mv-ui mv-message",innerHTML:this.message,events:{click:()=>Mavo.scrollIntoViewIfNeeded(this.mavo.element)},after:this.mavo.bar.element}),oe.classes&&this.element.classList.add(oe.classes),oe.dismiss=oe.dismiss||{},"string"==typeof oe.dismiss||Array.isArray(oe.dismiss)){var ie={};for(let de of Mavo.toArray(oe.dismiss))ie[de]=!0;oe.dismiss=ie}if(oe.dismiss.button&&ee.create("button",{className:"mv-close mv-ui",textContent:"\xD7",events:{click:()=>this.close()},start:this.element}),oe.dismiss.timeout){var le,se="number"==typeof oe.dismiss.timeout?oe.dismiss.timeout:5e3;ee.events(this.element,{mouseenter:()=>clearTimeout(le),mouseleave:Mavo.rr(()=>le=setTimeout(()=>this.close(),se))})}oe.dismiss.submit&&this.element.addEventListener("submit",de=>{de.preventDefault(),this.close(de.target)})},close:function(re){ee.transition(this.element,{opacity:0}).then(()=>{ee.remove(this.element),this.closed.resolve(re)})}})}(Bliss,Bliss.$),function(ee){var te=Mavo.Permissions=ee.Class({constructor:function(ae){this.triggers=[],this.hooks=new ee.Hooks,this.parentChanged=te.prototype.parentChanged.bind(this),this.set(ae)},set:function(ae){for(var re in ae)this[re]=ae[re]},on:function(ae){return Mavo.toArray(ae).forEach(re=>this[re]=!0),this},off:function(ae){return ae=Array.isArray(ae)?ae:[ae],ae.forEach(re=>this[re]=!1),this},can:function(ae,re,ne){this.observe(ae,!0,re),ne&&this.cannot(ae,ne)},cannot:function(ae,re){this.observe(ae,!1,re)},observe:function(ae,re,ne){ae=Mavo.toArray(ae),this.is(ae,re)&&ne(),this.triggers.push({actions:ae,value:re,callback:ne,active:!0})},is:function(ae,re=!0){var ne=Mavo.toArray(ae).map(oe=>!!this[oe]).reduce((oe,ie)=>oe||ie);return re?ne:!ne},onchange:function(ae){this.hooks.add("change",ae);for(let re of te.actions)ae.call(this,{action:re,value:this[re]})},parentChanged:function(ae={}){var re=this["_"+ae.action];void 0!==re||ae.from==ae.value||(this.fireTriggers(ae.action),this.hooks.run("change",ee.extend({context:this},ae)))},changed:function(ae,re,ne){ne=!!ne,re=!!re;re==ne||(this["_"+ae]=re,this.fireTriggers(ae),this.hooks.run("change",{action:ae,value:re,from:ne,context:this}))},fireTriggers:function(ae){for(let ne of this.triggers){var re=this.is(ne.actions,ne.value);ne.active&&-1<ne.actions.indexOf(ae)&&re?(ne.active=!1,ne.callback()):!re&&(ne.active=!0)}},or:function(ae){for(let re of te.actions)this[re]=this[re]||ae[re];return this},live:{parent:function(ae){var re=this._parent;if(re!=ae){this._parent=ae,re&&Mavo.delete(re.hooks.change,this.parentChanged);for(let ne of te.actions)this.parentChanged({action:ne,value:ae?ae[ne]:void 0,from:re?re[ne]:void 0});ae&&ae.onchange(this.parentChanged)}}},static:{actions:[],register:function(ae,re){return Array.isArray(ae)?void ae.forEach(ne=>te.register(ne,re)):void(ee.live(te.prototype,ae,{get:function(){var ne=this["_"+ae];return void 0===ne&&this.parent?this.parent[ae]:ne},set:function(ne,oe){re&&re.call(this,ne,oe),this.changed(ae,ne,oe)}}),te.actions.push(ae))}}});te.register(["read","save"]),te.register("login",function(ae){ae&&this.logout&&(this.logout=!1)}),te.register("logout",function(ae){ae&&this.login&&(this.login=!1)}),te.register("edit",function(ae){ae&&(this.add=this.delete=!0)}),te.register(["add","delete"],function(ae){ae||(this.edit=!1)})}(Bliss),function(ee){var te=Mavo.Backend=ee.Class({constructor:function(ae,re={}){this.source=ae,this.url=new URL(this.source,Mavo.base),this.mavo=re.mavo,this.format=Mavo.Formats.create(re.format,this),this.permissions=new Mavo.Permissions},get:function(){var ae=new URL(this.url);return ae.searchParams.set("timestamp",Date.now()),ee.fetch(this.url.href).then(re=>Promise.resolve(re.responseText),()=>Promise.resolve(null))},load:function(){return this.ready.then(()=>this.get()).then(ae=>{return"string"==typeof ae?(ae=ae.replace(/^\ufeff/,""),this.format.parse(ae)):ae})},store:function(ae,{path:re,format:ne=this.format}={}){return this.ready.then(()=>{var oe="string"==typeof ae?Promise.resolve(ae):ne.stringify(ae);return oe.then(ie=>this.put(ie,re).then(()=>{return{data:ae,serialized:ie}}))})},ready:Promise.resolve(),login:()=>Promise.resolve(),logout:()=>Promise.resolve(),isAuthenticated:function(){return!!this.accessToken},oAuthParams:()=>"",toString:function(){return`${this.id} (${this.url})`},equals:function(ae){return ae===this||ae&&this.id==ae.id&&this.source==ae.source},request:function(ae,re,ne="GET",oe={}){return oe.method=oe.method||ne,oe.responseType=oe.responseType||"json",oe.headers=oe.headers||{},oe.headers["Content-Type"]=oe.headers["Content-Type"]||"application/json; charset=utf-8",oe.data=re,this.isAuthenticated()&&(oe.headers.Authorization=oe.headers.Authorization||`Bearer ${this.accessToken}`),"object"===ee.type(oe.data)&&("GET"==oe.method?oe.data=Object.keys(oe.data).map(ie=>ie+"="+encodeURIComponent(oe.data[ie])).join("&"):oe.data=JSON.stringify(oe.data)),ae=new URL(ae,this.constructor.apiDomain),ee.fetch(ae,oe).catch(ie=>{return ie&&ie.xhr?Promise.reject(ie.xhr):void this.mavo.error("Something went wrong while connecting to "+this.id,ie)}).then(ie=>"HEAD"==oe.method?ie:ie.response)},oAuthenticate:function(ae){return this.ready.then(()=>{return this.isAuthenticated()?Promise.resolve():new Promise((re,ne)=>{var oe=this.id.toLowerCase();if(ae)this.accessToken=localStorage[`mavo:${oe}token`],this.accessToken&&re(this.accessToken);else{var ie={width:Math.min(1e3,innerWidth-100),height:Math.min(800,innerHeight-100)};ie.top=(innerHeight-ie.height)/2+(screen.top||screenTop),ie.left=(innerWidth-ie.width)/2+(screen.left||screenLeft);var se={url:location.href,backend:this.id};this.authPopup=open(`${this.constructor.oAuth}?client_id=${this.key}&state=${encodeURIComponent(JSON.stringify(se))}`+this.oAuthParams(),"popup",`width=${ie.width},height=${ie.height},left=${ie.left},top=${ie.top}`),addEventListener("message",le=>{le.source===this.authPopup&&(le.data.backend==this.id&&(this.accessToken=localStorage[`mavo:${oe}token`]=le.data.token),!this.accessToken&&ne(Error("Authentication error")),re(this.accessToken))})}})})},oAuthLogout:function(){if(this.isAuthenticated()){var ae=this.id.toLowerCase();localStorage.removeItem(`mavo:${ae}token`),delete this.accessToken,this.permissions.off(["edit","add","delete","save"]).on("login"),this.mavo.element._.fire("mavo:logout",{backend:this})}return Promise.resolve()},static:{create:function(ae,re){if(ae){var ne=te.types.filter(oe=>oe.test(ae))[0]||te.Remote;return new ne(ae,re)}return null},types:[],register:function(ae){return te[ae.prototype.id]=ae,te.types.push(ae),ae}}});te.register(ee.Class({id:"Element",extends:te,constructor:function(){this.permissions.on(["read","edit","save"]),this.element=ee(this.source)||ee.create("script",{type:"application/json",id:this.source.slice(1),inside:document.body})},get:function(){return Promise.resolve(this.element.textContent)},put:function(ae){return Promise.resolve(this.element.textContent=ae)},static:{test:ae=>0===ae.indexOf("#")}})),te.register(ee.Class({id:"Remote",extends:te,constructor:function(){this.permissions.on("read")},static:{test:()=>!1}})),te.register(ee.Class({extends:te,id:"Local",constructor:function(){this.permissions.on(["read","edit","save"]),this.key=this.mavo.id},get:function(){return Promise[this.key in localStorage?"resolve":"reject"](localStorage[this.key])},put:function(ae){return ae?localStorage[this.key]=ae:delete localStorage[this.key],Promise.resolve(ae)},static:{test:ae=>"local"==ae}}))}(Bliss),function(ee){var ae=Mavo.Formats={},re=ae.Base=ee.Class({abstract:!0,constructor:function(se){this.backend=se},proxy:{mavo:"backend"},parse:function(se){return this.constructor.parse(se,this)},stringify:function(se){return this.constructor.stringify(se,this)},static:{parse:se=>Promise.resolve(se),stringify:se=>Promise.resolve(se),extensions:[],dependencies:[],ready:function(){return Promise.all(this.dependencies.map(se=>ee.include(se.test(),se.url)))}}}),ne=ae.JSON=ee.Class({extends:ae.Base,static:{parse:se=>Promise.resolve(se?JSON.parse(se):null),stringify:se=>Promise.resolve(Mavo.toJSON(se)),extensions:[".json",".jsonld"]}}),oe=ae.Text=ee.Class({extends:ae.Base,constructor:function(){this.property=this.mavo.root.getNames("Primitive")[0]},static:{extensions:[".txt"],parse:(se,le)=>Promise.resolve({[le?le.property:"content"]:se}),stringify:(se,le)=>Promise.resolve(se[le?le.property:"content"])}}),ie=ae.CSV=ee.Class({extends:ae.Base,constructor:function(){this.property=this.mavo.root.getNames("Collection")[0],this.options=ee.extend({},ae.CSV.defaultOptions)},static:{extensions:[".csv",".tsv"],defaultOptions:{header:!0,dynamicTyping:!0,skipEmptyLines:!0},dependencies:[{test:()=>self.Papa,url:"https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.4/papaparse.min.js"}],ready:re.ready,parse:(se,le)=>ie.ready().then(()=>{var de=Papa.parse(se,ie.defaultOptions),pe=le?le.property:"content";if(le&&(le.options.delimiter=de.meta.delimiter,le.options.linebreak=de.meta.linebreak),de.meta.aborted)throw de.meta.errors.pop();return{[pe]:de.data}}),stringify:(se,le)=>ie.ready().then(()=>{var de=le?le.property:"content",pe=le?le.options:ie.defaultOptions;return Papa.unparse(data[de],pe)})}});Object.defineProperty(ae,"create",{value:function(se,le){if(se&&"object"==typeof se)return se;if("string"==typeof se)for(var de in se=se.toLowerCase(),ae){var pe=ae[de];if(de.toLowerCase()==se)return new pe(le)}if(!se){var ue=le.url?le.url.pathname:le.source,ce=(ue.match(/\.\w+$/)||[])[0]||".json",pe=ae.JSON;for(var de in ae)-1<ae[de].extensions.indexOf(ce)&&(pe=ae[de]);return new pe(le)}}})}(Bliss,Bliss.$),function(ee,te){var ae=Mavo.Node=ee.Class({abstract:!0,constructor:function(re,ne,oe={}){if(!re||!ne)throw new Error("Mavo.Node constructor requires an element argument and a mavo object");var ie={context:this,options:oe};this.uid=++ae.maxId,this.nodeType=this.nodeType,this.property=null,this.element=re,ee.extend(this,ie.options),ae.all.set(re,[...(ae.all.get(this.element)||[]),this]),this.template=ie.options.template,this.template?this.template.copies.push(this):this.copies=[],this.mavo=ne,this.group=this.parentGroup=ie.options.group,this.fromTemplate("property","type")||(this.property=ae.getProperty(re),this.type=Mavo.Group.normalize(re),this.storage=this.element.getAttribute("mv-storage")),this.modes=this.element.getAttribute("mv-mode"),Mavo.hooks.run("node-init-start",ie),this.mode=Mavo.getStyle(this.element,"--mv-mode")||"read",this.collection=ie.options.collection,this.collection&&(this.group=this.parentGroup=this.collection.parentGroup);var se=this.template;se&&se.expressions&&(this.expressions=se.expressions.map(le=>new Mavo.DOMExpression({template:le,item:this,mavo:this.mavo}))),Mavo.hooks.run("node-init-end",ie)},get editing(){return"edit"==this.mode},get isRoot(){return!this.property},get name(){return Mavo.Functions.readable(this.property||this.type).toLowerCase()},get saved(){return"none"!==this.storage},get path(){var re=this.parentGroup?this.parentGroup.path:[];return this.property?[...re,this.property]:re},postInit:function(){"edit"==this.modes&&this.edit()},destroy:function(){this.template&&Mavo.delete(this.template.copies,this)},getData:function(re={}){if(this.isDataNull(re))return null},isDataNull:function(re){var ne={context:this,options:re,result:this.deleted||!this.saved&&!re.live};return Mavo.hooks.run("unit-isdatanull",ne),ne.result},walk:function(re,ne=[]){var oe=(ie,se)=>{var le=re(ie,se);if(!1!==le)for(let de in ie.children){let pe=ie.children[de];if(pe instanceof Mavo.Node){var le=oe.call(pe,pe,[...se,de]);if(!1===le)return!1}}return!1!==le};return oe(this,ne)},walkUp:function(re){for(var oe,ne=this;ne=ne.parentGroup;)if(oe=re(ne),void 0!==oe)return oe},edit:function(){return this.mode="edit","edit"==this.mode&&void Mavo.hooks.run("node-edit-end",this)},done:function(){return this.mode=Mavo.getStyle(this.element.parentNode,"--mv-mode")||"read","read"==this.mode&&void(ee.unbind(this.element,".mavo:edit"),this.propagate("done"),Mavo.hooks.run("node-done-end",this))},propagate:function(re){for(let ne in this.children){let oe=this.children[ne];oe instanceof Mavo.Node&&("function"==typeof re?re.call(oe,oe):re in oe&&oe[re]())}},propagated:["save","destroy"],toJSON:Mavo.prototype.toJSON,fromTemplate:function(...re){if(this.template)for(let ne of re)this[ne]=this.template[ne];return!!this.template},render:function(re){this.oldData=this.data,this.data=re,re=Mavo.subset(re,this.inPath);var ne={context:this,data:re};if(Mavo.hooks.run("node-render-start",ne),"Collection"!=this.nodeType&&Array.isArray(re)){var oe;this.isRoot&&1===(oe=Object.keys(this.children)).length&&"Collection"===this.children[oe[0]].nodeType?ne.data={[oe[0]]:ne.data}:(this.inPath.push("0"),ne.data=ne.data[0])}this.editing?(this.done(),this.dataRender(ne.data),this.edit()):this.dataRender(ne.data),this.save(),Mavo.hooks.run("node-render-end",ne)},dataChanged:function(re,ne={}){ee.fire(ne.element||this.element,"mavo:datachange",ee.extend({property:this.property,action:re,mavo:this.mavo,node:this},ne))},toString:function(){return`#${this.uid}: ${this.nodeType} (${this.property})`},getClosestCollection:function(){return this.collection||this.group.collection||(this.parentGroup?this.parentGroup.closestCollection:null)},isDeleted:function(){this.deleted;return!!this.deleted||!!this.parentGroup&&this.parentGroup.isDeleted()},lazy:{closestCollection:function(){return this.getClosestCollection()},inPath:function(){return"Collection"==this.nodeType?[]:(this.element.getAttribute("mv-path")||"").split("/").filter(re=>re.length)}},live:{store:function(re){ee.toggleAttribute(this.element,"mv-storage",re)},unsavedChanges:function(re){return!re||this.saved&&this.editing||(re=!1),this.element.classList.toggle("mv-unsaved-changes",re),re},mode:function(re){if(this._mode!=re){if(this.modes&&re!=this.modes&&(re=this.modes),this._mode=re,!(this instanceof Mavo.Collection)&&-1<[null,"","read","edit"].indexOf(this.element.getAttribute("mv-mode"))){var ne=this.modes||"edit"==re;Mavo.Observer.sneak(this.mavo.modeObserver,()=>{ee.toggleAttribute(this.element,"mv-mode",re,ne)})}return re}},modes:function(re){return re&&"read"!=re&&"edit"!=re?null:void(this._modes=re,re&&this.mode!=re&&(this.mode=re))},deleted:function(re){this.element.classList.toggle("mv-deleted",re),re?(this.elementContents=document.createDocumentFragment(),te(this.element.childNodes).forEach(ne=>{this.elementContents.appendChild(ne)}),ee.contents(this.element,[{tag:"button",className:"mv-close mv-ui",textContent:"\xD7",events:{click:function(){ee.remove(this.parentNode)}}},"Deleted "+this.name,{tag:"button",className:"mv-undo mv-ui",textContent:"Undo",events:{click:()=>this.deleted=!1}}]),this.element.classList.remove("mv-highlight")):this.deleted&&(this.element.textContent="",this.element.appendChild(this.elementContents),this._deleted=!1,this.dataChanged("undelete"))}},static:{maxId:0,all:new WeakMap,create:function(re,ne,oe={}){return Mavo.is("multiple",re)&&!oe.collection?new Mavo.Collection(re,ne,oe):new Mavo[Mavo.is("group",re)?"Group":"Primitive"](re,ne,oe)},getProperty:function(re){var ne=re.getAttribute("property")||re.getAttribute("itemprop");return!ne&&re.hasAttribute("property")&&(ne=re.name||re.id||re.classList[0]),ne&&re.setAttribute("property",ne),ne},get:function(re,ne){var oe=(ae.all.get(re)||[]).filter(ie=>!(ie instanceof Mavo.Collection));return 2>oe.length||!ne?oe[0]:oe[0]instanceof Mavo.Group?node[1]:void 0},children:function(re){var ne=Mavo.Node.get(re);return ne?[ne]:(ne=te(Mavo.selectors.property,re).map(oe=>Mavo.Node.get(oe)).filter(oe=>!re.contains(oe.parentGroup.element)).map(oe=>oe.collection||oe),Mavo.Functions.unique(ne))}}})}(Bliss,Bliss.$),function(ee,te){var ae=Mavo.Group=ee.Class({extends:Mavo.Node,nodeType:"Group",constructor:function(){if(this.children={},this.group=this,Mavo.hooks.run("group-init-start",this),Mavo.Primitive.getValueAttribute(this.element))this.children[this.property]=new Mavo.Primitive(this.element,this.mavo,{group:this});te(Mavo.selectors.property,this.element).forEach(le=>{var de=Mavo.Node.getProperty(le);if(this.contains(le)){var pe=this.children[de],ue=this.template?this.template.children[de]:null,ce={template:ue,group:this};if(pe){var he=pe;pe instanceof Mavo.Collection||(he=new Mavo.Collection(pe.element,this.mavo,ce),this.children[de]=pe.collection=he,he.add(pe)),!he.mutable&&Mavo.is("multiple",le)&&(he.mutable=!0),he.add(le)}else{var ge=Mavo.Node.create(le,this.mavo,ce);this.children[de]=ge}}});var se=(this.isRoot?this.element.closest("[vocab]"):null)||this.element;this.vocab=se.getAttribute("vocab"),this.postInit(),Mavo.hooks.run("group-init-end",this)},get isRoot(){return!this.property},getNames:function(re="Node"){return Object.keys(this.children).filter(ne=>this.children[ne]instanceof Mavo[re])},getData:function(re={}){var ne={context:this,options:re,data:this.super.getData.call(this,re)};if(void 0!==ne.data)return ne.data;for(let ie in ne.data=this.data?Mavo.clone(Mavo.subset(this.data,this.inPath)):{},this.children){let se=this.children[ie];if(se.saved||ne.options.live){let le=se.getData(re);(null!==le||ne.options.live)&&(ne.data[se.property]=le)}}ne.options.live||(ne.data=Mavo.subset(this.data,this.inPath,ne.data));var oe=Object.keys(ne.data);return 1==oe.length&&oe[0]==this.property&&(ne.data=ne.data[this.property]),ne.options.live||(oe.length||this.isRoot?ne.data&&"object"==typeof ne.data&&(this.type&&this.type!=ae.DEFAULT_TYPE&&(ne.data["@type"]=this.type),this.vocab&&(ne.data["@context"]=this.vocab)):ne.data=null),Mavo.hooks.run("node-getdata-end",ne),ne.data},find:function(re,ne={}){if(this.property==re)return this;if(re in this.children)return this.children[re].find(re,ne);var oe=[];for(var ie in this.children){var se=this.children[ie].find(re,ne);if(se!==void 0)if(Array.isArray(se))oe.push(...se);else return se}if(oe.length)return oe},edit:function(){return!1!==this.super.edit.call(this)&&void this.propagate("edit")},save:function(){this.unsavedChanges=!1},propagated:["save","import","clear"],dataRender:function(re){if(re)if("object"!=typeof re){var ne=se=>(se==this.property)+!this.children[se].expressionText+(this.children[se]instanceof Mavo.Primitive),oe=Object.keys(this.children).sort((se,le)=>ne(se)-ne(le)).reverse()[0];re={[oe]:re},this.data=Mavo.subset(this.data,this.inPath,re),this.propagate(se=>{se.render(re[se.property])})}else{this.propagate(se=>{se.render(re[se.property])});var ie=Mavo.subset(this.oldData,this.inPath);for(let se in re)if(!(se in this.children)){let le=re[se];"object"==typeof le||ie&&ie[se]==le||this.dataChanged("propertychange",{property:se})}}},contains:function(re){return re instanceof Mavo.Node?re.parentGroup===this:re.parentNode&&this.element===re.parentNode.closest(Mavo.selectors.group)},static:{all:new WeakMap,DEFAULT_TYPE:"Item",normalize:function(re){if(Mavo.is("group",re)){var ne=Mavo.getAttribute(re,"typeof","itemtype")||ae.DEFAULT_TYPE;return re.setAttribute("typeof",ne),ne}return null}}})}(Bliss,Bliss.$),function(ee,te){var ae=Mavo.Primitive=ee.Class({extends:Mavo.Node,nodeType:"Primitive",constructor:function(re){if(this.fromTemplate("config","attribute","templateValue")||(this.config=ae.getConfig(re),this.attribute=this.config.attribute),this.datatype=this.config.datatype,"modes"in this.config&&(this.modes=this.config.modes,this.element.setAttribute("mv-mode",this.config.modes)),Mavo.hooks.run("primitive-init-start",this),this.expressionText=Mavo.DOMExpression.search(this.element,this.attribute),this.expressionText&&!this.expressionText.mavoNode&&(this.expressionText.primitive=this,this.storage=this.storage||"none",this.modes="read"),this.config.init&&this.config.init.call(this,this.element),this.config.changeEvents&&ee.events(this.element,this.config.changeEvents,se=>{se.target===this.element&&(this.value=this.getValue())}),!this.editor&&this.element.hasAttribute("mv-edit")){var ie=ee(this.element.getAttribute("mv-edit"));ie&&(this.editor=ie.cloneNode(!0),!this.template&&new Mavo.Observer(ie,"all",()=>{var le=this.copies.concat(this);for(let de of le)de.editor=ie.cloneNode(!0),de.setValue(de.value,{force:!0,silent:!0})}))}this.editor||this.attribute||(this.editor=te(this.element.children).filter(function(se){return se.matches(Mavo.selectors.formControl)&&!se.matches(Mavo.selectors.property)})[0],this.editor&&(this.element.textContent=this.editorValue,ee.remove(this.editor))),this.templateValue=this.getValue(),this._default=this.element.getAttribute("mv-default"),null===this.default?this._default="read"===this.modes?this.templateValue:this.editor?this.editorValue:void 0:""===this.default?this._default=this.templateValue:this.defaultObserver=new Mavo.Observer(this.element,"mv-default",()=>{this.default=this.element.getAttribute("mv-default")}),this.initialValue=(this.template||void 0!==this.default?this.default:this.templateValue)||this.emptyValue,this.setValue(this.initialValue,{silent:!0}),this.observer=new Mavo.Observer(this.element,this.attribute,()=>{(this.attribute||!this.editing)&&(this.value=this.getValue())}),this.postInit(),Mavo.hooks.run("primitive-init-end",this)},get editorValue(){if(this.config.getEditorValue)return this.config.getEditorValue.call(this);if(this.editor){if(this.editor.matches(Mavo.selectors.formControl))return ae.getValue(this.editor,{datatype:this.datatype});var re=ee(Mavo.selectors.output+", "+Mavo.selectors.formControl,this.editor);if(re)return ae.getValue(re)}},set editorValue(re){if(this.config.setEditorValue)return this.config.setEditorValue.call(this,re);if(this.editor)if(this.editor.matches(Mavo.selectors.formControl))ae.setValue(this.editor,re,{config:this.editorDefaults});else{var ne=ee(Mavo.selectors.output+", "+Mavo.selectors.formControl,this.editor);ne&&ae.setValue(ne,re)}},destroy:function(){this.super.destroy.call(this),this.defaultObserver&&this.defaultObserver.destroy(),this.observer&&this.observer.destroy()},getData:function(re={}){var ne={context:this,options:re,data:this.super.getData.call(this,re)};return void 0===ne.data?(ne.data=this.value,""===ne.data&&(ne.data=null),!re.live&&this.inPath.length&&(ne.data=Mavo.subset(this.data,this.inPath,ne.data)),Mavo.hooks.run("node-getdata-end",ne),ne.data):ne.data},sneak:function(re){return Mavo.Observer.sneak(this.observer,re)},save:function(){this.savedValue=this.value,this.unsavedChanges=!1},initEdit:function(){if(!this.editor){var re=this.config.editor||Mavo.Elements.defaultEditors[this.datatype]||Mavo.Elements.defaultEditors.string;this.editor=ee.create("function"===ee.type(re)?re.call(this):re),this.editorValue=this.value}ee.events(this.editor,{"input change":()=>{this.value=this.editorValue},focus:()=>{this.editor.select&&this.editor.select()},"mavo:datachange":oe=>{"output"===oe.property&&(oe.stopPropagation(),ee.fire(this.editor,"input"))}}),"placeholder"in this.editor&&(this.editor.placeholder="("+this.label+")");var ne=/^mv-edit-/i;te(this.element.attributes).forEach(function(oe){ne.test(oe.name)&&this.editor.setAttribute(oe.name.replace(ne,""),oe.value)},this),(this.attribute||this.config.popup)&&(this.popup=new Mavo.UI.Popup(this)),this.popup||this.editor.classList.add("mv-editor"),this.initEdit=null},edit:function(){return!1!==this.super.edit.call(this)&&(this.element._.data.prevTabindex=this.element.getAttribute("tabindex"),this.element.tabIndex=0,this.element.addEventListener("click.mavo:edit",re=>re.preventDefault()),this.preEdit=Mavo.defer(re=>{if(this.empty&&!this.attribute)return requestAnimationFrame(re);var oe,ie="click focus dragover dragenter".split(" ").map(se=>se+".mavo:preedit").join(" ");ee.events(this.element,ie,re),this.attribute||ee.events(this.element,{"mouseenter.mavo:preedit":()=>{clearTimeout(oe),oe=setTimeout(re,150)},"mouseleave.mavo:preedit":()=>{clearTimeout(oe)}})}).then(()=>ee.unbind(this.element,".mavo:preedit")),this.config.edit?void this.config.edit.call(this):void this.preEdit.then(()=>{this.initEdit&&this.initEdit(),this.popup&&this.popup.show(),this.attribute||this.popup||this.editor.parentNode==this.element||(this.editorValue=this.value,this.element.textContent="",this.element.appendChild(this.editor))}))},done:function(){return!1!==this.super.done.call(this)&&void("preEdit"in this&&ee.unbind(this.element,".mavo:preedit .mavo:edit"),this.sneak(()=>{return this.config.done?void this.config.done.call(this):void(this.popup?this.popup.close():!this.attribute&&this.editor&&(ee.remove(this.editor),this.element.textContent=this.editorValue))}),null===this.element._.data.prevTabindex?this.element.removeAttribute("tabindex"):this.element.tabIndex=this.element._.data.prevTabindex)},clear:function(){this.value=this.templateValue},dataRender:function(re){if(re&&"object"==typeof re)if(Symbol.toPrimitive in re)re=re[Symbol.toPrimitive]();else for(let ne of[this.property,"value",...Object.keys(re)])if(ne in re){re=re[ne],this.inPath.push(ne);break}re===void 0?"read"!=this.modes&&(this.value=this.closestCollection?this.default:this.templateValue):this.value=re},find:function(re){if(this.property==re)return this},getValue:function(){return ae.getValue(this.element,{config:this.config,attribute:this.attribute,datatype:this.datatype})},lazy:{label:function(){return Mavo.Functions.readable(this.property)},emptyValue:function(){switch(this.datatype){case"boolean":return!1;case"number":return 0;}return""},editorDefaults:function(){return this.editor&&ae.getConfig(this.editor)}},setValue:function(re,ne={}){return this.sneak(()=>{if("object"==ee.type(re)&&"value"in re){var oe=re.presentational;re=re.value}return re=re||0===re?re:"",this.datatype||"number"!=typeof re&&"boolean"!=typeof re||(this.datatype=typeof re),re=ae.safeCast(re,this.datatype),re!=this._value||ne.force?void(this.editor&&document.activeElement!=this.editor&&(this.editorValue=re),this.config.humanReadable&&this.attribute&&(oe=this.config.humanReadable.call(this,re)),(!this.editing||this.popup||!this.editor)&&(this.config.setValue?this.config.setValue.call(this,this.element,re):(this.editor&&this.editor.matches("select")&&this.editor.selectedOptions[0]&&(oe=this.editor.selectedOptions[0].textContent),!ne.dataOnly&&ae.setValue(this.element,{value:re,presentational:oe},{config:this.config,attribute:this.attribute,datatype:this.datatype}))),this.empty=""===re,this._value=re,!ne.silent&&(this.saved&&(this.unsavedChanges=this.mavo.unsavedChanges=!0),this.dataChanged("propertychange",{value:re}))):re}),re},dataChanged:function(re="propertychange",ne){return this.super.dataChanged.call(this,re,ne)},live:{default:function(re){this.value==this._default&&(this.value=re)},value:function(re){return this.setValue(re)},empty:function(re){var ne=re&&!this.modes&&this.config.default&&!(this.attribute&&ee(Mavo.selectors.property,this.element));this.element.classList.toggle("mv-empty",!!ne)}},static:{all:new WeakMap,getValueAttribute:function(re,ne=Mavo.Elements.search(re)){var oe=re.getAttribute("mv-attribute")||ne.attribute;return oe&&"null"!==oe&&"none"!==oe||(oe=null),oe},safeCast:function(re,ne){var ie=ae.cast(re,ne);return null===re||void 0===re?re:"boolean"==ne?"false"===re||0===re||""===re?!1:"true"===re||0<re||re:"number"==ne?/^[-+]?[0-9.e]+$/i.test(re+"")?ie:re:ie},cast:function(re,ne){return"number"===ne?+re:"boolean"===ne?!!re:"string"===ne?re+"":re},getValue:function(re,{config:ne,attribute:oe,datatype:ie}={}){if(ne||(ne=ae.getConfig(re,oe)),oe=ne.attribute,ie=ne.datatype,ne.getValue&&oe==ne.attribute)return ne.getValue(re);var se;return se=oe in re&&ae.useProperty(re,oe)?re[oe]:oe?re.getAttribute(oe):re.getAttribute("content")||re.textContent||null,ae.safeCast(se,ie)},getConfig:function(re,ne,oe){void 0===ne&&(ne=re.getAttribute("mv-attribute")||void 0),("null"==ne||"none"==ne)&&(ne=null),oe=re.getAttribute("datatype")||void 0;var ie=Mavo.Elements.search(re,ne,oe);return void 0===ie.attribute&&(ie.attribute=ne||null),void 0===ie.datatype&&(ie.datatype=oe),ie},setValue:function(re,ne,{config:oe,attribute:ie,datatype:se}={}){if("object"==ee.type(ne)&&"value"in ne){var le=ne.presentational;ne=ne.value}if(1===re.nodeType&&(oe||(oe=ae.getConfig(re,ie)),ie=oe.attribute,se=void 0===se?oe.datatype:se,oe.setValue&&ie==oe.attribute))return oe.setValue(re,ne);if(ie){if(ie in re&&ae.useProperty(re,ie)&&re[ie]!==ne)try{re[ie]=ne}catch(de){}"boolean"==se?ne!=re.hasAttribute(ie)&&ee.toggleAttribute(re,ie,ne,ne):re.getAttribute(ie)!=ne&&(re.setAttribute(ie,ne),le&&(re.textContent=le))}else"number"!==se||le||(le=ae.formatNumber(ne)),re.textContent=le||ne,le&&re.setAttribute&&re.setAttribute("content",ne)},useProperty:function(re,ne){return!(-1<["href","src"].indexOf(ne))&&"http://www.w3.org/2000/svg"!=re.namespaceURI},lazy:{formatNumber:()=>{var re=new Intl.NumberFormat("en-US",{maximumFractionDigits:2});return function(ne){return ne===Infinity||ne===-Infinity?0>ne?"-\u221E":"\u221E":re.format(ne)}}}}})}(Bliss,Bliss.$),function(ee){Mavo.UI.Popup=ee.Class({constructor:function(re){this.primitive=re,this.position=()=>{var oe=this.element.getBoundingClientRect(),ie=oe.left,se=oe.bottom;if(this.popup.offsetHeight){var le=this.popup.getBoundingClientRect();le.height+se>innerHeight&&(se=innerHeight-le.height-20)}ee.style(this.popup,{top:`${se}px`,left:`${ie}px`})},this.popup=ee.create("div",{className:"mv-popup",hidden:!0,contents:{tag:"fieldset",contents:[{tag:"legend",textContent:this.primitive.label+":"},this.editor]},events:{keyup:ne=>{(13==ne.keyCode||27==ne.keyCode)&&(this.popup.contains(document.activeElement)&&this.element.focus(),ne.stopPropagation(),this.hide())},transitionend:this.position}}),this.editor.matches("select")&&(this.editor.size=Math.min(10,this.editor.children.length))},show:function(){ee.unbind([this.element,this.popup],".mavo:showpopup"),this.shown=!0,this.hideCallback=re=>{this.popup.contains(re.target)||this.element.contains(re.target)||this.hide()},this.position(),document.body.appendChild(this.popup),requestAnimationFrame(()=>this.popup.removeAttribute("hidden")),ee.events(document,"focus click",this.hideCallback,!0),window.addEventListener("scroll",this.position)},hide:function(){ee.unbind(document,"focus click",this.hideCallback,!0),window.removeEventListener("scroll",this.position),this.popup.setAttribute("hidden",""),this.shown=!1,setTimeout(()=>{ee.remove(this.popup)},1e3*parseFloat(getComputedStyle(this.popup).transitionDuration)||400),ee.events(this.element,{"click.mavo:showpopup":()=>{this.show()},"keyup.mavo:showpopup":re=>{-1<[13,113].indexOf(re.keyCode)&&(this.show(),this.editor.focus())}})},close:function(){this.hide(),ee.unbind(this.element,".mavo:edit .mavo:preedit .mavo:showpopup")},proxy:{editor:"primitive",element:"primitive"}})}(Bliss,Bliss.$),function(ee){var ae=Mavo.Elements={};Object.defineProperties(ae,{register:{value:function(re){if("object"==typeof arguments[0]){for(let ie in arguments[0])ae.register(ie,arguments[0][ie]);return}var oe=Mavo.toArray(arguments[1]);for(config of oe){config.attribute=Mavo.toArray(config.attribute||null);for(attribute of config.attribute){let ie=ee.extend({},config);ie.attribute=attribute,ie.selector=ie.selector||re,ie.id=re,ae[re]=ae[re]||[],ae[re].push(ie)}}return ae}},search:{value:function(re,ne,oe){var ie=ae.matches(re,ne,oe);return ie[ie.length-1]||{attribute:ne}}},matches:{value:function(re,ne,oe){var ie=[];selectorloop:for(var se in ae)for(var le of ae[se]){var de=ne===void 0&&le.default||ne===le.attribute;if(de&&(void 0===oe||"string"===oe||oe===le.datatype)){var pe=le.selector||se;re.matches(pe)&&(!le.test||le.test(re,ne,oe))&&ie.push(le)}}return ie}},isSVG:{value:re=>"http://www.w3.org/2000/svg"==re.namespaceURI},defaultEditors:{value:{string:{tag:"input"},number:{tag:"input",type:"number"},boolean:{tag:"input",type:"checkbox"}}}}),ae.register({"*":[{test:(re,ne)=>"hidden"==ne,attribute:"hidden",datatype:"boolean"},{test:ae.isSVG,attribute:"y",datatype:"number"},{default:!0,test:ae.isSVG,attribute:"x",datatype:"number"}],media:{default:!0,selector:"img, video, audio",attribute:"src",editor:function(){var re=this.mavo.storage&&this.mavo.storage.upload?this.mavo.storage:this.uploadBackend,ne=ee.create("input",{type:"url",placeholder:"http://example.com/image.png",className:"mv-output","aria-label":"URL to image"});if(re&&self.FileReader){var oe,ie=this.element.nodeName.toLowerCase();ie="img"==ie?"image":ie;var se=this.element.getAttribute("mv-uploads")||ie+"s",le=(pe,ue=pe.name)=>{pe&&0===pe.type.indexOf(ie+"/")&&this.mavo.upload(pe,se+"/"+ue).then(ce=>{ne.value=ce,ee.fire(ne,"input")})},de={paste:pe=>{var ue=pe.clipboardData.items[0];if("file"==ue.kind&&0===ue.type.indexOf(ie+"/")){var ce=`pasted-${ie}-${Date.now()}.${ue.type.slice(6)}`;le(ue.getAsFile(),ce),pe.preventDefault()}},"drag dragstart dragend dragover dragenter dragleave drop":pe=>{pe.preventDefault(),pe.stopPropagation()},"dragover dragenter":()=>{oe.classList.add("mv-dragover"),this.element.classList.add("mv-dragover")},"dragleave dragend drop":()=>{oe.classList.remove("mv-dragover"),this.element.classList.remove("mv-dragover")},drop:pe=>{le(pe.dataTransfer.files[0])}};return ee.events(this.element,de),oe=ee.create({className:"mv-upload-popup",contents:[ne,{tag:"input",type:"file","aria-label":"Upload image",accept:ie+"/*",events:{change:pe=>{var ue=pe.target.files[0];ue&&le(ue)}}},{className:"mv-tip",innerHTML:"<strong>Tip:</strong> You can also drag & drop or paste!"}],events:de})}return ne}},"video, audio":{attribute:["autoplay","buffered","loop"],datatype:"boolean"},"a, link":{default:!0,attribute:"href"},"input, select, button, textarea":{attribute:"disabled",datatype:"boolean"},"select, input":{default:!0,attribute:"value",modes:"read",changeEvents:"input change"},textarea:{default:!0,modes:"read",changeEvents:"input",getValue:re=>re.value,setValue:(re,ne)=>re.value=ne},"input[type=range], input[type=number]":{default:!0,attribute:"value",datatype:"number",modes:"read",changeEvents:"input change"},"input[type=checkbox]":{default:!0,attribute:"checked",datatype:"boolean",modes:"read",changeEvents:"click"},"input[type=radio]":{default:!0,attribute:"checked",modes:"read",getValue:re=>{if(re.form)return re.form[re.name].value;var ne=ee(`input[type=radio][name="${re.name}"]:checked`);return ne&&ne.value},setValue:(re,ne)=>{if(re.form)return void(re.form[re.name].value=ne);var oe=ee(`input[type=radio][name="${re.name}"][value="${ne}"]`);ee.properties(oe,{checked:!0})},init:function(re){this.mavo.element.addEventListener("change",ne=>{ne.target.name==re.name&&(this.value=this.getValue())})}},"button, .counter":{default:!0,attribute:"mv-clicked",datatype:"number",modes:"read",init:function(re){"mv-clicked"===this.attribute&&(re.setAttribute("mv-clicked","0"),re.addEventListener("click",()=>{let oe=+re.getAttribute("mv-clicked")||0;this.value=++oe}))}},"meter, progress":{default:!0,attribute:"value",datatype:"number",edit:function(){var re=+this.element.getAttribute("min")||0,ne=+this.element.getAttribute("max")||1,oe=ne-re,ie=+this.element.getAttribute("mv-edit-step")||(1<oe?1:oe/100);this.element.addEventListener("mousemove.mavo:edit",se=>{var le=this.element.getBoundingClientRect().left,de=Math.max(0,(se.clientX-le)/this.element.offsetWidth),pe=re+oe*de,ue=pe%ie;pe+=ue>ie/2?ie-ue:-ue,pe=Math.max(re,Math.min(pe,ne)),this.sneak(()=>this.element.setAttribute("value",pe))}),this.element.addEventListener("mouseleave.mavo:edit",()=>{this.sneak(()=>this.element.setAttribute("value",this.value))}),this.element.addEventListener("click.mavo:edit",()=>{this.value=this.getValue()}),this.element.addEventListener("keydown.mavo:edit",se=>{if(se.target==this.element&&(37==se.keyCode||39==se.keyCode)){var le=ie*(39==se.keyCode?1:-1)*(se.shiftKey?10:1),de=this.value+le;de=Math.max(re,Math.min(de,ne)),this.element.setAttribute("value",de)}})},done:function(){ee.unbind(this.element,".mavo:edit")}},meta:{default:!0,attribute:"content"},block:{default:!0,selector:"p, div, li, dt, dd, h1, h2, h3, h4, h5, h6, article, section, address",editor:function(){var re=getComputedStyle(this.element).display,ne=0===re.indexOf("inline")?"input":"textarea",oe=ee.create(ne);if("textarea"==ne){var ie=this.element.offsetWidth;ie&&(oe.width=ie)}return oe},setEditorValue:function(re){this.datatype&&"string"!=this.datatype&&(re+="");var ne=getComputedStyle(this.element);return re=re||"",-1<["normal","nowrap"].indexOf(ne.whiteSpace)&&(re=re.replace(/\r?\n/g," ")),-1<["normal","nowrap","pre-line"].indexOf(ne.whiteSpace)&&(re=re.replace(/^[ \t]+|[ \t]+$/gm,"").replace(/[ \t]+/g," ")),this.editor.value=re,!0}},time:{attribute:"datetime",default:!0,editor:function(){var re={date:/^[Y\d]{4}-[M\d]{2}-[D\d]{2}$/i,month:/^[Y\d]{4}-[M\d]{2}$/i,time:/^[H\d]{2}:[M\d]{2}/i,week:/[Y\d]{4}-W[W\d]{2}$/i,"datetime-local":/^[Y\d]{4}-[M\d]{2}-[D\d]{2} [H\d]{2}:[M\d]{2}/i},ne=this.element.getAttribute("datetime")||"YYYY-MM-DD";for(var oe in re)if(re[oe].test(ne))break;return{tag:"input",type:oe}},humanReadable:function(re){var ne=new Date(re);if(!re||isNaN(ne))return"(No "+this.label+")";var oe={date:{day:"numeric",month:"short",year:"numeric"},month:{month:"long"},time:{hour:"numeric",minute:"numeric"},"datetime-local":{day:"numeric",month:"short",year:"numeric",hour:"numeric",minute:"numeric"}},ie=oe[this.editor&&this.editor.type]||oe.date;return ie.timeZone="UTC",ne.toLocaleString("en-GB",ie)}},circle:[{default:!0,attribute:"r",datatype:"number"},{attribute:["cx","cy"],datatype:"number"}],text:{default:!0,popup:!0},"[role=checkbox]":{default:!0,attribute:"aria-checked",datatype:"boolean",edit:function(){this.element.addEventListener("click.mavo:edit",re=>{this.value=!this.value,re.preventDefault()})},done:function(){ee.unbind(this.element,".mavo:edit")}}})}(Bliss,Bliss.$),function(ee,te){Mavo.attributes.push("mv-multiple","mv-order","mv-accepts");var ae=Mavo.Collection=ee.Class({extends:Mavo.Node,nodeType:"Collection",constructor:function(){if(this.templateElement=this.element,this.children=[],this.fromTemplate("properties","mutable","templateElement","accepts")||(this.properties=te(Mavo.selectors.property,this.templateElement).map(Mavo.Node.getProperty),this.mutable=this.templateElement.matches(Mavo.selectors.multiple),this.accepts=(this.templateElement.getAttribute("mv-accepts")||"").split(/\s+/),this.templateElement=this.templateElement.cloneNode(!0)),this.mutable){var ie=this.createItem(this.element);this.add(ie),this.itemTemplate=ie.template||ie}this.postInit(),Mavo.hooks.run("collection-init-end",this)},get length(){return this.children.length},getData:function(re={}){var ne={context:this,options:re,data:[]};for(item of this.children)if(!item.deleted||ne.options.live){let ie=item.getData(ne.options);(ie||ne.options.live)&&ne.data.push(ie)}if(!this.mutable)if(ne.data=ne.data.filter(ie=>null!==ie),ne.options.live&&1===ne.data.length)ne.data=ne.data[0];else if(this.data&&!ne.options.live){var oe=Mavo.subset(this.data,this.inPath);ne.data=ne.data.concat(oe.slice(ne.data.length))}return Mavo.hooks.run("node-getdata-end",ne),ne.data},createItem:function(re){re||(re=this.templateElement.cloneNode(!0));var ne=Mavo.Node.create(re,this.mavo,{collection:this,template:this.itemTemplate||(this.template?this.template.itemTemplate:null),property:this.property,type:this.type});return ne},add:function(re,ne,oe={}){if(re=re instanceof Node?Mavo.Node.get(re)||this.createItem(re):re||this.createItem(),re.collection!=this&&this.adopt(re),this.mutable){var ie=this.children[ne]?this.children[ne].element:this.marker;ee[this.bottomUp?"after":"before"](re.element,ie),void 0===ne&&(ne=this.bottomUp?0:this.length)}else ne=this.length;var se={context:this,item:re};return se.previousIndex=re.index,se.changed=this.splice({remove:se.item},{index:ne,add:se.item}),requestAnimationFrame(()=>{oe.silent||(se.changed.forEach(le=>{le.dataChanged(le==se.item&&void 0===se.previousIndex?"add":"move"),le.unsavedChanges=!0}),this.unsavedChanges=this.mavo.unsavedChanges=!0),this.mavo.expressions.update(se.item.element)}),Mavo.hooks.run("collection-add-end",se),se.item},splice:function(...re){for(let oe of re)void 0===oe.index&&oe.remove&&isNaN(oe.remove)&&(oe.index=this.children.indexOf(oe.remove),oe.remove=1);re.sort((oe,ie)=>ie.index-oe.index);for(let oe of re)-1<oe.index&&(oe.remove||oe.add)&&(oe.remove=oe.remove||0,oe.add=Mavo.toArray(oe.add),this.children.splice(oe.index,+oe.remove,...oe.add));var ne=[];for(let ie,oe=0;oe<this.length;oe++)ie=this.children[oe],ie&&ie.index!==oe&&(ie.index=oe,ne.push(ie));return ne},adopt:function(re){re.collection&&(re.collection.splice({remove:re}),re.collection.dataChanged("delete")),this.walk(ne=>{ne.closestCollection===re.collection&&(ne.closestCollection=this),re.mavo!=this.mavo&&(re.mavo=this.mavo)}),re.collection=this,re.template&&(Mavo.delete(re.template.copies,re),re.template=this.itemTemplate)},delete:function(re,ne){return ne?(ee.remove(re.element),this.splice({remove:re}),void re.destroy()):ee.transition(re.element,{opacity:0}).then(()=>{re.deleted=!0,re.element.style.opacity="",re.dataChanged("delete"),this.unsavedChanges=re.unsavedChanges=this.mavo.unsavedChanges=!0})},move:function(re,ne){index=re.index+ne+(0<ne),0>index?index=this.children.length:index>this.children.length&&(index=0),this.add(re,index)},editItem:function(re){re.itemControls||(re.itemControls=new Mavo.UI.Itembar(re)),re.itemControls.add(),re.edit()},edit:function(){if(!1===this.super.edit.call(this))return!1;if(this.mutable){if(!this.addButton.parentNode){var re=this.element.tagName.toLowerCase(),ne=Mavo.selectors.container[re],oe=ne?this.marker.parentNode.closest(ne):this.marker;ee[this.bottomUp?"before":"after"](this.addButton,oe)}this.propagate(ie=>{this.editItem(ie)}),ae.dragula.then(()=>{this.getDragula()})}},done:function(){return!1!==this.super.done.call(this)&&void(this.mutable&&(this.addButton.parentNode&&this.addButton.remove(),this.propagate(re=>{re.itemControls&&re.itemControls.remove()})))},clear:function(){if(this.mutable){for(var ne,re=1;ne=this.children[re];re++)ne.element.remove(),ne.destroy();this.children=this.children.slice(0,1),this.dataChanged("clear")}this.propagate("clear")},dataChanged:function(re,ne={}){return ne.element=ne.element||this.marker,this.super.dataChanged.call(this,re,ne)},save:function(){for(let re of this.children)re.deleted?this.delete(re,!0):re.unsavedChanges=!1},propagated:["save"],dataRender:function(re){if(re)if(re=Mavo.toArray(re),!this.mutable)this.children.forEach((de,pe)=>de.render(re&&re[pe]));else{for(var ne=0;ne<this.children.length;ne++)ne<re.length?this.children[ne].render(re[ne]):(this.children[ne].dataChanged("delete"),this.delete(this.children[ne],!0));if(re.length>ne){for(var se,oe=document.createDocumentFragment(),ie=ne;ie<re.length;ie++){se=this.createItem(),se.render(re[ie]),this.children.push(se),se.index=ie,oe.appendChild(se.element);var le={context:this,item:se};Mavo.hooks.run("collection-add-end",le),se.dataChanged("add")}this.bottomUp?ee.after(oe,0<ne?this.children[ne-1].element:this.marker):ee.before(oe,this.marker)}}},find:function(re,ne={}){var oe=this.children.filter(se=>!se.deleted);if(this.property==re)return ne.collections?this:oe;if(-1<this.properties.indexOf(re)){var ie=oe.map(se=>se.find(re,ne));return Mavo.flatten(ie)}},isCompatible:function(re){return re&&this.itemTemplate.nodeType==re.itemTemplate.nodeType&&(re===this||re.template==this||this.template==re||this.template&&this.template==re.template||-1<this.accepts.indexOf(re.property))},live:{mutable:function(re){re&&re!==this.mutable&&(this._mutable=re,this.marker=document.createComment("mv-marker"),Mavo.data(this.marker,"collection",this),ee.after(this.marker,this.templateElement))}},getDragula:function(){if(this.dragula)return this.dragula;if(this.template)return Mavo.pushUnique(this.template.getDragula().containers,this.marker.parentNode),this.dragula=this.template.dragula||this.template.getDragula();this;return this.dragula=dragula({containers:[this.marker.parentNode],isContainer:ne=>{return!!this.accepts.length&&-1<Mavo.flatten(this.accepts.map(oe=>this.mavo.root.find(oe,{collections:!0}))).filter(oe=>oe&&oe instanceof ae).map(oe=>oe.marker.parentNode).indexOf(ne)},moves:(ne,oe,ie)=>{return ie.classList.contains("mv-drag-handle")&&ie.closest(Mavo.selectors.multiple)==ne},accepts:function(ne,oe,ie,se){if(ne.contains(oe))return!1;var le=se?se.previousElementSibling:oe.lastElementChild,de=ae.get(le)||ae.get(se);if(!de)return!1;var pe=Mavo.Node.get(ne);return pe&&pe.collection.isCompatible(de)}}),this.dragula.on("drop",ne=>{var se=Mavo.Node.get(ne),le=se&&se.index,de=ne.nextElementSibling,pe=ne.previousElementSibling,ue=ae.get(pe)||ae.get(de),ce=Mavo.Node.get(pe)||Mavo.Node.get(de);if(ce&&ce.collection!=ue&&(ce=null),se.collection.isCompatible(ue)){var he=ce?ce.index+(ce.element===pe):ue.length;ue.add(se,he)}else return this.dragula.cancel(!0)}),ae.dragulas.push(this.dragula),this.dragula},lazy:{bottomUp:function(){if(!this.mutable)return!1;var re=this.templateElement.getAttribute("mv-order");return null===re?!!this.addButton.parentNode&&!!(this.addButton.compareDocumentPosition(this.marker)&Node.DOCUMENT_POSITION_FOLLOWING):/^desc\b/i.test(re)},closestCollection:function(){var re=this.marker?this.marker.parentNode:this.templateElement.parentNode;return re.closest(Mavo.selectors.multiple)},addButton:function(){var re=`button.mv-add-${this.property}`,ne=this.closestCollection||this.marker.parentNode.closest(Mavo.selectors.group);if(ne)var oe=te(re,ne).filter(ie=>{return!this.templateElement.contains(ie)})[0];return oe||(oe=ee.create("button",{className:"mv-add",textContent:"Add "+this.name})),oe.classList.add("mv-ui","mv-add"),Mavo.data(oe,"collection",this),this.property&&oe.classList.add(`mv-add-${this.property}`),oe.addEventListener("click",ie=>{ie.preventDefault(),this.editItem(this.add())}),oe}},static:{dragulas:[],get:re=>{var ne=Mavo.data(re,"collection");if(ne)return ne;var oe=Mavo.Node.get(re);return oe&&oe.collection||null},lazy:{dragula:()=>ee.include(self.dragula,"https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js")}}})}(Bliss,Bliss.$),function(ee,te){Mavo.UI.Itembar=ee.Class({constructor:function(re){this.item=re,this.element=te(`.mv-item-bar:not([mv-rel]), .mv-item-bar[mv-rel="${this.item.property}"]`,this.item.element).filter(ne=>{return ne.closest(Mavo.selectors.multiple)==this.item.element&&!Mavo.data(ne,"item")})[0],this.element=this.element||ee.create({className:"mv-item-bar mv-ui"}),Mavo.data(this.element,"item",this.item),ee.set(this.element,{"mv-rel":this.item.property,contents:[{tag:"button",title:"Delete this "+this.item.name,className:"mv-delete",events:{click:()=>this.item.collection.delete(re)}},{tag:"button",title:`Add new ${this.item.name.replace(/s$/i,"")} ${this.collection.bottomUp?"after":"before"}`,className:"mv-add",events:{click:ne=>{var oe=this.collection.add(null,this.item.index);return ne[Mavo.superKey]&&oe.render(this.item.data),Mavo.scrollIntoViewIfNeeded(oe.element),this.collection.editItem(oe)}}},{tag:"button",title:"Drag to reorder "+this.item.name,className:"mv-drag-handle",events:{click:ne=>ne.target.focus(),keydown:ne=>{37<=ne.keyCode&&40>=ne.keyCode&&(this.move(this.item,38>=ne.keyCode?-1:1),ne.stopPropagation(),ne.preventDefault(),ne.target.focus())}}}],events:{mouseenter:()=>{this.item.element.classList.add("mv-highlight")},mouseleave:()=>{this.item.element.classList.remove("mv-highlight")}}})},add:function(){this.element.parentNode||Mavo.revocably.add(this.element)||(this.item instanceof Mavo.Primitive&&!this.item.attribute?(this.element.classList.add("mv-adjacent"),ee.after(this.element,this.item.element)):this.item.element.appendChild(this.element))},remove:function(){Mavo.revocably.remove(this.element)},proxy:{collection:"item",mavo:"item"}})}(Bliss,Bliss.$),function(ee){Mavo.attributes.push("mv-expressions");var te=Mavo.Expression=ee.Class({constructor:function(ae){this.expression=ae},eval:function(ae){this.oldValue=this.value,Mavo.hooks.run("expression-eval-beforeeval",this);try{this.function||(this.function=te.compile(this.expression),this.identifiers=this.expression.match(/[$a-z][$\w]*/ig)||[]),this.value=this.function(ae)}catch(re){console.info("%cExpression error!","color: red; font-weight: bold",`${re.message} in expression ${this.expression}`),Mavo.hooks.run("expression-eval-error",{context:this,exception:re}),this.value=re}return this.value},toString(){return this.expression},changedBy:function(ae){if(!ae)return!0;if(!this.identifiers)return!1;if(-1<this.identifiers.indexOf(ae.property))return!0;if(Mavo.hasIntersection(ae.properties,this.identifiers))return!0;if("propertychange"!=ae.action){if(Mavo.hasIntersection(["$index","$all","$previous","$next"],this.identifiers))return!0;var re=ae.node.collection||ae.node;if(Mavo.hasIntersection(re.properties,this.identifiers))return!0}return!1},live:{expression:function(ae){ae=ae;this.function=null}},static:{serializers:{BinaryExpression:ae=>`${te.serialize(ae.left)} ${ae.operator} ${te.serialize(ae.right)}`,UnaryExpression:ae=>`${ae.operator}${te.serialize(ae.argument)}`,CallExpression:ae=>`${te.serialize(ae.callee)}(${ae.arguments.map(te.serialize).join(", ")})`,ConditionalExpression:ae=>`${te.serialize(ae.test)}? ${te.serialize(ae.consequent)} : ${te.serialize(ae.alternate)}`,MemberExpression:ae=>`get(${te.serialize(ae.object)}, "${ae.property.name||ae.property.value}")`,ArrayExpression:ae=>`[${ae.elements.map(te.serialize).join(", ")}]`,Literal:ae=>ae.raw,Identifier:ae=>ae.name,ThisExpression:()=>"this",Compound:ae=>ae.body.map(te.serialize).join(" ")},transformations:{BinaryExpression:ae=>{let re=Mavo.Script.getOperatorName(ae.operator),ne=Mavo.Script.operators[re];var oe=ae,ie=[];do ie.unshift(oe.right),oe=oe.left;while(Mavo.Script.getOperatorName(oe.operator)===re);if(ie.unshift(oe),1<ie.length)return`${re}(${ie.map(te.serialize).join(", ")})`},CallExpression:ae=>{"Identifier"==ae.callee.type&&"if"==ae.callee.name&&(ae.callee.name="iff")}},serialize:ae=>{if(te.transformations[ae.type]){var re=te.transformations[ae.type](ae);if(re!==void 0)return re}return te.serializers[ae.type](ae)},rewrite:function(ae){try{return te.serialize(te.parse(ae))}catch(re){return ae}},compile:function(ae){return ae=te.rewrite(ae),new Function("data",`with(Mavo.Functions._Trap)
					with (data || {}) {
						return ${ae};
					}`)},parse:self.jsep}});self.jsep&&(jsep.addBinaryOp("and",2),jsep.addBinaryOp("or",2),jsep.addBinaryOp("=",6),jsep.addBinaryOp("mod",10),jsep.removeBinaryOp("===")),te.serializers.LogicalExpression=te.serializers.BinaryExpression,te.transformations.LogicalExpression=te.transformations.BinaryExpression,te.Syntax=ee.Class({constructor:function(ae,re){this.start=ae,this.end=re,this.regex=RegExp(`${Mavo.escapeRegExp(ae)}([\\S\\s]+?)${Mavo.escapeRegExp(re)}`,"gi")},test:function(ae){return this.regex.lastIndex=0,this.regex.test(ae)},tokenize:function(ae){var re,ne=[],oe=0;for(this.regex.lastIndex=0;null!==(re=this.regex.exec(ae));)re.index>oe&&ne.push(ae.substring(oe,re.index)),oe=this.regex.lastIndex,ne.push(new Mavo.Expression(re[1]));return oe<ae.length&&ne.push(ae.substring(oe)),ne},static:{create:function(ae){if(ae){var re=ae.getAttribute("mv-expressions");if(re)return re=re.trim(),/\s/.test(re)?new te.Syntax(...re.split(/\s+/)):te.Syntax.ESCAPE}},ESCAPE:-1}}),te.Syntax.default=new te.Syntax("[","]")}(Bliss),function(ee){var te=Mavo.DOMExpression=ee.Class({constructor:function(ae={}){this.mavo=ae.mavo,this.template=ae.template&&ae.template.template||ae.template;for(let ne of["item","path","syntax","fallback","attribute"])this[ne]=void 0===ae[ne]&&this.template?this.template[ne]:ae[ne];if(this.node=ae.node,this.node||(this.node=this.path.reduce((ne,oe)=>{return ne.childNodes[oe]},this.item.element)),this.element=this.node,this.attribute=this.attribute||null,Mavo.hooks.run("domexpression-init-start",this),!this.expression){if(3===this.node.nodeType&&(this.element=this.node.parentNode,(!this.node.parentNode.children.length||this.attribute)&&(this.node=this.element,this.element.normalize())),this.attribute)this.expression=this.node.getAttribute(this.attribute).trim();else{if(this.node.normalize(),this.node.firstChild&&1===this.node.childNodes.length&&3===this.node.firstChild.nodeType){var re=this.node.firstChild.textContent.match(/^\s*|\s*$/g);re[1]&&(this.node.firstChild.splitText(this.node.firstChild.textContent.length-re[1].length),ee.after(this.node.lastChild,this.node)),re[0]&&(this.node.firstChild.splitText(re[0].length),this.node.parentNode.insertBefore(this.node.firstChild,this.node))}this.expression=this.node.textContent}this.parsed=ae.template?ae.template.parsed:this.syntax.tokenize(this.expression)}this.oldValue=this.value=this.parsed.map(ne=>ne instanceof Mavo.Expression?ne.expression:ne),this.mavo.treeBuilt.then(()=>{this.template||(this.item=Mavo.Node.get(this.element.closest(Mavo.selectors.multiple+", "+Mavo.selectors.group)),this.item.expressions=[...(this.item.expressions||[]),this]),Mavo.hooks.run("domexpression-init-treebuilt",this)}),Mavo.hooks.run("domexpression-init-end",this),te.elements.set(this.element,[...(te.elements.get(this.element)||[]),this])},changedBy:function(ae){return!this.parsed.every(re=>!(re instanceof Mavo.Expression)||!re.changedBy(ae))},update:function(ae=this.data,re){var ne={context:this,ret:{},event:re},oe=ne;this.data=ae,ne.ret={},Mavo.hooks.run("domexpression-update-start",ne),this.oldValue=this.value,ne.ret.value=this.value=this.parsed.map((ie,se)=>{if(ie instanceof Mavo.Expression){if(ie.changedBy(oe.event)){var le={context:this,expr:ie,parentEnv:oe};return Mavo.hooks.run("domexpression-update-beforeeval",le),le.value=le.expr.eval(ae),Mavo.hooks.run("domexpression-update-aftereval",le),le.value instanceof Error?void 0===this.fallback?le.expr.expression:this.fallback:void 0===le.value||null===le.value?"":le.value}return this.oldValue[se]}return ie}),this.attribute||(ne.ret.presentational=this.value.map(ie=>{return Array.isArray(ie)?ie.join(", "):"number"==typeof ie?Mavo.Primitive.formatNumber(ie):ie}),ne.ret.presentational=1===ne.ret.presentational.length?ne.ret.presentational[0]:ne.ret.presentational.join("")),ne.ret.value=1===ne.ret.value.length?ne.ret.value[0]:ne.ret.value.join(""),this.primitive&&1===this.parsed.length&&("number"==typeof ne.ret.value?this.primitive.datatype="number":"boolean"==typeof ne.ret.value&&(this.primitive.datatype="boolean")),ne.ret.presentational===ne.ret.value&&(ret=ne.ret.value),this.output(ne.ret),Mavo.hooks.run("domexpression-update-end",ne)},output:function(ae){this.primitive?this.primitive.value=ae:(ae=ae.presentational||ae,Mavo.Primitive.setValue(this.node,ae,{attribute:this.attribute}))},static:{elements:new WeakMap,search:function(ae,re){var ne=te.elements.get(ae)||[];return 1<arguments.length?ne.length?ne.filter(oe=>oe.attribute===re)[0]||null:null:ne}}})}(Bliss),function(ee,te){var ae=Mavo.Expressions=ee.Class({constructor:function(re){this.mavo=re,this.active=!0,this.expressions=[];var ne=Mavo.Expression.Syntax.create(this.mavo.element.closest("[mv-expressions]"))||Mavo.Expression.Syntax.default;this.traverse(this.mavo.element,void 0,ne),this.scheduled=new Set,this.mavo.treeBuilt.then(()=>{this.expressions=[],document.documentElement.addEventListener("mavo:datachange",oe=>{this.active&&("propertychange"==oe.action&&oe.node.closestCollection?!this.scheduled.has(oe.property)&&(setTimeout(()=>{this.scheduled.delete(oe.property),this.update(oe)},ae.PROPERTYCHANGE_THROTTLE),this.scheduled.add(oe.property)):requestAnimationFrame(()=>this.update(oe)))}),this.update()})},update:function(re){var ne,oe;re instanceof Element&&(ne=re.closest(Mavo.selectors.group),re=null),ne=ne||this.mavo.element,oe=Mavo.Node.get(ne);var ie=oe.getData({live:!0});oe.walk((se,le)=>{if(se.expressions&&se.expressions.length&&!se.isDeleted()){let de={context:this,data:ee.value(ie,...le)};Mavo.hooks.run("expressions-update-start",de);for(let pe of se.expressions)pe.changedBy(re)&&pe.update(de.data,re)}})},extract:function(re,ne,oe,ie){ne&&"mv-expressions"==ne.name||(ne&&-1<ae.directives.indexOf(ne.name)||ie.test(ne?ne.value:re.textContent))&&this.expressions.push(new Mavo.DOMExpression({node:re,syntax:ie,path:oe?oe.slice(1).split("/").map(se=>+se):[],attribute:ne&&ne.name,mavo:this.mavo}))},traverse:function(re,ne="",oe){if(8!==re.nodeType)if(3===re.nodeType)this.extract(re,null,ne,oe);else{if(re.normalize(),oe=Mavo.Expression.Syntax.create(re)||oe,oe===Mavo.Expression.Syntax.ESCAPE)return;Mavo.is("multiple",re)&&(ne=""),te(re.attributes).forEach(ie=>this.extract(re,ie,ne,oe)),te(re.childNodes).forEach((ie,se)=>this.traverse(ie,`${ne}/${se}`,oe))}},static:{directives:[],PROPERTYCHANGE_THROTTLE:50,directive:function(re,ne){ae.directives.push(re),Mavo.attributes.push(re),ne.name=re,Mavo.Plugins.register(ne)}}});self.Proxy&&Mavo.hooks.add("node-getdata-end",function(re){if(re.options.live&&re.data&&("object"==typeof re.data||this.collection)){var ne=re.data;"object"!=typeof re.data&&(re.data={[Symbol.toPrimitive]:()=>ne,[this.property]:ne}),re.data=new Proxy(re.data,{get:(oe,ie,se)=>{if(ie in oe||ie in se&&ie in oe)return oe[ie]},has:(oe,ie)=>{if(ie in oe)return!0;switch(ie){case"$index":return oe[ie]=this.index||0,!0;case"$all":return oe[ie]=this.closestCollection?this.closestCollection.getData(re.options):[re.data];case"$next":case"$previous":return this.closestCollection?oe[ie]=this.closestCollection.getData(re.options)[this.index+("$next"==ie?1:-1)]:(oe[ie]=null,null);case"$edit":return oe[ie]=this.editing,!0;}if(this instanceof Mavo.Group&&ie==this.property&&this.collection)return oe[ie]=re.data;var se=this.walkUp(le=>{if(ie in le.children)return le.children[ie]});return void 0===se&&(se=this.find(ie)),void 0===se?ie in Mavo.all&&Mavo.all[ie].root&&(oe[ie]=Mavo.all[ie].root.getData(re.options)):(Array.isArray(se)?se=se.map(le=>le.getData(re.options)).filter(le=>null!==le):se instanceof Mavo.Node&&(se=se.getData(re.options)),oe[ie]=se,!0)},set:function(){throw Error("You can\u2019t set data via expressions.")}})}})}(Bliss,Bliss.$),function(ee,te){Mavo.Expressions.directive("mv-if",{extend:{Primitive:{live:{hidden:function(ae){this._hidden!==ae&&(this._hidden=ae,this.dataChanged())}}},DOMExpression:{lazy:{childProperties:function(){if("mv-if"==this.attribute){var ae=te(Mavo.selectors.property,this.element).filter(re=>re.closest("[mv-if]")==this.element).map(re=>Mavo.Node.get(re));return this.element.addEventListener("mavo:datachange",re=>{requestAnimationFrame(()=>{this.element.parentNode||this.item.element.dispatchEvent(re)})}),ae}}}}},hooks:{"domexpression-init-start":function(){"mv-if"!=this.attribute||(this.expression=this.element.getAttribute("mv-if"),this.parsed=[new Mavo.Expression(this.expression)],this.expression=this.syntax.start+this.expression+this.syntax.end,this.parentIf=this.element.parentNode&&Mavo.DOMExpression.search(this.element.parentNode.closest("[mv-if]"),"mv-if"),this.parentIf&&(this.parentIf.childIfs=(this.parentIf.childIfs||new Set).add(this)))},"domexpression-update-end":function(){if("mv-if"==this.attribute){var ae=this.value[0],re=this.oldValue[0];this.item.mavo.treeBuilt.then(()=>{if(this.parentIf){var ne=this.parentIf.value[0];this.value[0]=ae=ae&&ne}if(ae!==re){if(!1!==ne&&(ae?Mavo.revocably.add(this.element):this.element.parentNode&&Mavo.revocably.remove(this.element,"mv-if")),this.childProperties)for(let oe of this.childProperties)oe.hidden=!ae;if(this.childIfs)for(let oe of this.childIfs)oe.update()}})}},"unit-isdatanull":function(ae){ae.result=ae.result||this.hidden&&ae.options.live}}})}(Bliss,Bliss.$),Mavo.Expressions.directive("mv-value",{hooks:{"node-init-start":function(){if(this instanceof Mavo.Group||this.collection){var ee=Mavo.DOMExpression.search(this.element).filter(te=>"mv-value"==te.originalAttribute)[0];ee&&(ee.mavoNode=this,this.expressionText=ee,this.storage=this.storage||"none",this.modes="read",this.collection&&(this.collection.expressions=[...(this.collection.expressions||[]),ee],ee.mavoNode=this.collection,this.collection.storage=this.collection.storage||"none",this.collection.modes="read"))}},"domexpression-init-start":function(){"mv-value"!=this.attribute||(this.originalAttribute="mv-value",this.attribute=Mavo.Primitive.getValueAttribute(this.element),this.fallback=this.fallback||Mavo.Primitive.getValue(this.element,{attribute:this.attribute}),this.expression=this.element.getAttribute("mv-value"),this.element.removeAttribute("mv-value"),this.parsed=[new Mavo.Expression(this.expression)],this.expression=this.syntax.start+this.expression+this.syntax.end)},"domexpression-init-treebuilt":function(){"mv-value"==this.originalAttribute&&this.mavoNode&&(this.mavoNode==this.item||this.mavoNode==this.item.collection)&&(this.mavoNode==this.item.collection&&Mavo.delete(this.item.expressions,this),this.output=function(ee){ee=ee.value||ee,this.mavoNode.render(ee)},this.changedBy=()=>!0)},"domexpression-update-start":function(){"mv-value"==this.originalAttribute&&this.mavoNode==this.item}}}),function(){function ee(ie,se){return ie=Array.isArray(ie)?ie:se?$$(se):[ie],ie.filter(le=>!isNaN(le)&&""!==le).map(le=>+le)}function te(ie){if(!ie)return null;if("string"===$.type(ie)){-1===ie.indexOf(":")?ie+="T00:00:00":ie=ie.replace(/\-(\d{2})\s+(?=\d{2}:)/,"-$1T"),ie=ie.replace(/\s+/g,"");var se=(ie.match(/[+-]\d{2}:?\d{2}|Z$/)||[])[0];if(!se){var le=re.localTimezone,de=Math.abs(le%60),pe=(Math.abs(le)-de)/60,ue=0>le?"-":"+";ie+=ue+oe(pe)+":"+oe(de)}}return ie=new Date(ie),isNaN(ie)?null:ie}function ae(ie,se="numeric",le){var de=document.documentElement.lang||"en-GB";return function(pe,ue=se){if(pe=te(pe),!pe)return"";var ce=$.extend({[ie]:ue,hour12:!1},le);if("weekday"==ie&&"numeric"==ue)he=pe.getDay()||7;else var he=pe.toLocaleString(de,ce);return"numeric"!=ue||isNaN(he)||(he=new Number(he),("month"==ie||"weekday"==ie)&&(ce[ie]="long",he.name=pe.toLocaleString(de,ce),ce[ie]="short",he.shortname=pe.toLocaleString(de,ce)),"weekday"!=ie&&(ce[ie]="2-digit",he.twodigit=pe.toLocaleString(de,ce))),he}}var re=Mavo.Functions={operators:{"=":"eq"},get:function(ie,se){if(ie&&void 0!==ie[se])return ie[se];if(Array.isArray(ie)&&isNaN(se)&&"object"==typeof ie[0])for(var le=0;le<ie.length;le++)if(ie[le]&&ie[le].id==se)return ie[le];return null},unique:function(ie){return[...new Set(ie)]},sum:function(ie){return ee(ie,arguments).reduce((se,le)=>{return+se+(+le||0)},0)},average:function(ie){return ie=ee(ie,arguments),ie.length&&re.sum(ie)/ie.length},min:function(ie){return Math.min(...ee(ie,arguments))},max:function(ie){return Math.max(...ee(ie,arguments))},count:function(ie){return Mavo.toArray(ie).filter(se=>null!==se&&!1!==se&&""!==se).length},round:function(ie,se){return ie&&se&&isFinite(ie)?+ie.toLocaleString("en-US",{useGrouping:!1,maximumFractionDigits:se}):Math.round(ie)},iff:function(ie,se,le=""){return Array.isArray(ie)?ie.map((de,pe)=>{var ue=de?se:le;return Array.isArray(ue)?ue[Math.min(pe,ue.length-1)]:ue}):ie?se:le},replace:function(ie,se,le="",de=1){if(Array.isArray(ie))return ie.map(ge=>re.replace(ge,se,le));for(var ce,pe=RegExp(Mavo.escapeRegExp(se),"g"),ue=ie,he=0;ue!=ce&&he++<de;)ce=ue,ue=ue.replace(pe,le);return ue},len:ie=>(ie||"").length,search:(ie,se)=>ie&&se?(ie+"").toLowerCase().indexOf((se+"").toLowerCase()):-1,starts:(ie,se)=>0===re.search(ie+"",se+""),ends:function(ie,se){ie+="",se+="";var le=re.search(ie,se);return-1<le&&le===ie.length-se.length},join:function(ie,se=""){return Mavo.toArray(ie).join(se)},idify:function(ie){return((ie||"")+"").replace(/\s+/g,"-").replace(/[^\w-]/g,"").toLowerCase()},readable:function(ie){return ie&&ie.replace(/([a-z])([A-Z])(?=[a-z])/g,(se,le,de)=>le+" "+de.toLowerCase()).replace(/([a-z])[_\/-](?=[a-z])/g,"$1 ").replace(/^[a-z]/,se=>se.toUpperCase())},uppercase:ie=>(ie+"").toUpperCase(),lowercase:ie=>(ie+"").toLowerCase(),get $now(){return new Date},year:ae("year"),month:ae("month"),day:ae("day"),weekday:ae("weekday"),hour:ae("hour"),hour12:ae("hour","numeric",{hour12:!0}),minute:ae("minute"),second:ae("second"),date:ie=>{return`${re.year(ie)}-${re.month(ie).twodigit}-${re.day(ie).twodigit}`},time:ie=>{return`${re.hour(ie).twodigit}:${re.minute(ie).twodigit}:${re.second(ie).twodigit}`},minutes:ie=>Math.floor(Math.abs(ie)/60),hours:ie=>Math.floor(Math.abs(ie)/3600),days:ie=>Math.floor(Math.abs(ie)/86400),weeks:ie=>Math.floor(Math.abs(ie)/604800),months:ie=>Math.floor(Math.abs(ie)/(30.4368*86400)),years:ie=>Math.floor(Math.abs(ie)/(12*(30.4368*86400))),localTimezone:-new Date().getTimezoneOffset(),log:(...ie)=>{return console.log(ie),ie[0]}};for(let ie in $.lazy(Mavo.Functions,"$url",function(){var ie={},se=new URL(location);for(let le of se.searchParams)ie[le[0]]=le[1];return Object.defineProperty(ie,"toString",{value:()=>new URL(location)}),ie}),Mavo.Script={addUnaryOperator:function(ie,se){return le=>Array.isArray(le)?le.map(se.scalar):se.scalar(le)},addBinaryOperator:function(ie,se){if(se.symbol)for(let le of Mavo.toArray(se.symbol))Mavo.Script.symbols[le]=ie;return se.identity=void 0===se.identity?0:se.identity,re[ie]=se.code||function(...le){1===le.length&&Array.isArray(le[0])&&(le=[...le[0]]);var pe,de=se.logical?se.identity:le[0];for(let ue=1;ue<le.length;ue++){let ce=se.logical?le[ue-1]:de,he=le[ue];Array.isArray(he)?("number"==typeof se.identity&&(he=ee(he)),pe=Array.isArray(ce)?[...he.map((ge,ve)=>se.scalar(void 0===ce[ve]?se.identity:ce[ve],ge)),...ce.slice(he.length)]:he.map(ge=>se.scalar(ce,ge))):Array.isArray(ce)?pe=ce.map(ge=>se.scalar(ge,he)):pe=se.scalar(ce,he),de=se.reduce?se.reduce(de,pe,ce,he):se.logical?de&&pe:pe}return de}},symbols:{},getOperatorName:ie=>Mavo.Script.symbols[ie]||ie,operators:{not:{scalar:()=>se=>!se},multiply:{scalar:(ie,se)=>ie*se,identity:1,symbol:"*"},divide:{scalar:(ie,se)=>ie/se,identity:1,symbol:"/"},add:{scalar:(ie,se)=>+ie+ +se,symbol:"+"},subtract:{scalar:(ie,se)=>{if(isNaN(ie)||isNaN(se)){var le=te(ie),de=te(se);if(le&&de)return(le-de)/1e3}return ie-se},symbol:"-"},mod:{scalar:(ie,se)=>{var le=ie%se;return le+=0>le?se:0,le}},lte:{logical:!0,scalar:(ie,se)=>{return[ie,se]=Mavo.Script.getNumericalOperands(ie,se),ie<=se},identity:!0,symbol:"<="},lt:{logical:!0,scalar:(ie,se)=>{return[ie,se]=Mavo.Script.getNumericalOperands(ie,se),ie<se},identity:!0,symbol:"<"},gte:{logical:!0,scalar:(ie,se)=>{return[ie,se]=Mavo.Script.getNumericalOperands(ie,se),ie>=se},identity:!0,symbol:">="},gt:{logical:!0,scalar:(ie,se)=>{return[ie,se]=Mavo.Script.getNumericalOperands(ie,se),ie>se},identity:!0,symbol:">"},eq:{logical:!0,scalar:(ie,se)=>ie==se,symbol:["=","=="],identity:!0},neq:{logical:!0,scalar:(ie,se)=>ie!=se,symbol:["!="],identity:!0},and:{logical:!0,scalar:(ie,se)=>!!ie&&!!se,identity:!0,symbol:"&&"},or:{logical:!0,scalar:(ie,se)=>!!ie||!!se,reduce:(ie,se)=>ie||se,identity:!1,symbol:"||"},concatenate:{symbol:"&",identity:"",scalar:(ie,se)=>""+(ie||"")+(se||"")},filter:{scalar:(ie,se)=>se?ie:null}},getNumericalOperands:function(ie,se){if(isNaN(ie)||isNaN(se)){var le=te(ie),de=te(se);if(le&&de)return[le,de]}return[ie,se]}},Mavo.Script.operators){let se=Mavo.Script.operators[ie];2>se.scalar.length?Mavo.Script.addUnaryOperator(ie,se):Mavo.Script.addBinaryOperator(ie,se)}var ne={average:"avg",iff:"iff IF",subtract:"minus",multiply:"mult product",divide:"div",lt:"lessThan smaller",gt:"moreThan greater greaterThan bigger",eq:"equal equality"};for(let ie in ne)ne[ie].split(/\s+/g).forEach(se=>re[se]=re[ie]);Mavo.Functions._Trap=self.Proxy?new Proxy(re,{get:(ie,se)=>{if(se in ie)return ie[se];var le=se.toLowerCase&&se.toLowerCase();return le&&ie.hasOwnProperty(le)?ie[le]:se in Math||le in Math?Math[se]||Math[le]:se in self?self[se]:se},has:(ie,se)=>"data"!=se}):Mavo.Functions;var oe=new Intl.NumberFormat("en",{minimumIntegerDigits:"2"});oe=oe.format.bind(oe)}(),function(ee){var te=Mavo.Backend.register(ee.Class({extends:Mavo.Backend,id:"Dropbox",constructor:function(){this.permissions.on(["login","read"]),this.key=this.mavo.element.getAttribute("mv-dropbox-key")||"2mx6061p054bpbp",this.url=te.fixShareURL(this.url),this.login(!0)},upload:function(ae,re){return re=this.path.replace(/[^/]+$/,"")+re,this.put(ae,re).then(()=>this.getURL(re))},getURL:function(ae){return this.request("sharing/create_shared_link_with_settings",{path:ae},"POST").then(re=>te.fixShareURL(re.url))},put:function(ae,re=this.path,ne={}){return this.request("https://content.dropboxapi.com/2/files/upload",ae,"POST",{headers:{"Dropbox-API-Arg":JSON.stringify({path:re,mode:"overwrite"}),"Content-Type":"application/octet-stream"}})},oAuthParams:()=>`&redirect_uri=${encodeURIComponent("https://auth.mavo.io")}&response_type=code`,getUser:function(){return this.user?Promise.resolve(this.user):this.request("users/get_current_account","null","POST").then(ae=>{this.user={username:ae.email,name:ae.name.display_name,avatar:ae.profile_photo_url,info:ae}})},login:function(ae){return this.oAuthenticate(ae).then(()=>this.getUser()).then(()=>{this.user&&(this.permissions.logout=!0,this.request("sharing/get_shared_link_metadata",{url:this.source},"POST").then(ne=>{this.path=ne.path_lower,this.permissions.on(["edit","save"])}))})},logout:function(){return this.oAuthLogout()},static:{apiDomain:"https://api.dropboxapi.com/2/",oAuth:"https://www.dropbox.com/oauth2/authorize",test:function(ae){return ae=new URL(ae,Mavo.base),/dropbox.com/.test(ae.host)},fixShareURL:ae=>{return ae=new URL(ae,Mavo.base),ae.hostname="dl.dropboxusercontent.com",ae.search=ae.search.replace(/\bdl=0|^$/,"raw=1"),ae}}}))}(Bliss),function(ee){var te=Mavo.Backend.register(ee.Class({extends:Mavo.Backend,id:"Github",constructor:function(){this.permissions.on(["login","read"]),this.key=this.mavo.element.getAttribute("mv-github-key")||"7e08e016048000bc594e";var ae=te.parseURL(this.url);ae.username?(ee.extend(this,ae),this.repo=this.repo||"mv-data",this.path=this.path||`${this.mavo.id}.json`,this.apiCall=`repos/${this.username}/${this.repo}/contents/${this.path}`):this.apiCall=this.url.pathname.slice(1),this.login(!0)},get:function(){return this.request(this.apiCall).then(ae=>Promise.resolve(this.repo?te.atob(ae.content):ae))},upload:function(ae,re=this.path){return Mavo.readFile(ae).then(ne=>{var oe=ne.slice(5),ie=oe.match(/^\w+\/[\w+]+/)[0];return oe=oe.replace(RegExp(`^${ie}(;base64)?,`),""),re=this.path.replace(/[^/]+$/,"")+re,this.put(oe,re,{isEncoded:!0})}).then(ne=>this.getURL(re,ne.commit.sha))},put:function(ae,re=this.path,ne={}){if(re){var oe=`repos/${this.username}/${this.repo}`,ie=`${oe}/contents/${re}`,se=this.mavo.element.getAttribute("mv-github-commit-prefix"),le=this.repoInfo||this.request("user/repos",{name:this.repo},"POST").then(de=>this.repoInfo=de);return ae=ne.isEncoded?ae:te.btoa(ae),Promise.resolve(le).then(de=>{return this.canPush()?de:this.request(`${oe}/forks`,{name:this.repo},"POST").then(pe=>{return ie=`repos/${pe.full_name}/contents/${re}`,this.forkInfo=pe}).then(pe=>{var ue,ce=he=>{clearTimeout(ue),this.request(`repos/${pe.full_name}/commits`,{until:"1970-01-01T00:00:00Z"},"HEAD").then(()=>{he(pe)}).catch(()=>{ue=setTimeout(ce,1e3)})};return new Promise(ce)})}).then(()=>{return this.request(ie,{ref:this.branch}).then(pe=>this.request(ie,{message:`${se} Updated ${pe.name||"file"}`,content:ae,branch:this.branch,sha:pe.sha},"PUT"),pe=>{return 404==pe.status?this.request(ie,{message:se+"Created file",content:ae,branch:this.branch},"PUT"):pe})}).then(de=>{return this.forkInfo&&this.request(`repos/${this.username}/${this.repo}/pulls`,{head:`${this.user.username}:${this.branch}`,base:this.branch}).then(pe=>{this.pullRequest(pe[0])}),de})}},pullRequest:function(ae){var re=new URL(location);re.searchParams.set(this.mavo.id+"-storage",`https://github.com/${this.forkInfo.full_name}/${this.path}`);var ne=`Your edits are saved to <a href="${re}" target="_blank">your own profile</a>, because you are not allowed to edit this page.`;this.notice&&this.notice.close(),ae?(this.notice=this.mavo.message(`${ne}
				You have selected to suggest your edits to the page admins. Your suggestions have not been reviewed yet.
				<form onsubmit="return false">
					<button class="mv-danger">Revoke edit suggestion</button>
				</form>`,{classes:"mv-inline",dismiss:["button","submit"]}),this.notice.closed.then(oe=>{oe&&this.request(`repos/${this.username}/${this.repo}/pulls/${ae.number}`,{state:"closed"},"POST").then(ie=>{new Mavo.UI.Message(this.mavo,`<a href="${ie.html_url}">Edit suggestion cancelled successfully!</a>`,{dismiss:["button","timeout"]}),this.pullRequest()})})):(this.notice=this.mavo.message(`${ne}
				Write a short description of your edits below to suggest them to the page admins:
				<form onsubmit="return false">
					<textarea name="edits" class="mv-autosize" placeholder="I added / corrected / deleted ..."></textarea>
					<button>Send edit suggestion</button>
				</form>`,{classes:"mv-inline",dismiss:["button","submit"]}),this.notice.closed.then(oe=>{oe&&this.request(`repos/${this.username}/${this.repo}/pulls`,{title:"Suggested edits to data",body:`Hello there! I used Mavo to suggest the following edits:
${oe.elements.edits.value}
Preview my changes here: ${re}`,head:`${this.user.username}:${this.branch}`,base:this.branch},"POST").then(ie=>{new Mavo.UI.Message(this.mavo,`<a href="${ie.html_url}">Edit suggestion sent successfully!</a>`,{dismiss:["button","timeout"]}),this.pullRequest(ie)})}))},login:function(ae){return this.oAuthenticate(ae).then(()=>this.getUser()).catch(re=>{401==re.status&&this.logout()}).then(()=>{if(this.user&&(this.permissions.on(["edit","save","logout"]),this.repo))return this.request(`repos/${this.username}/${this.repo}`).then(ne=>{return void 0===this.branch&&(this.branch=ne.default_branch),this.repoInfo=ne})})},canPush:function(){return this.repoInfo?this.repoInfo.permissions.push:this.user&&this.user.username.toLowerCase()==this.username.toLowerCase()},oAuthParams:()=>"&scope=repo,gist",logout:function(){return this.oAuthLogout().then(()=>{this.user=null})},getUser:function(){return this.user?Promise.resolve(this.user):this.request("user").then(ae=>{this.user={username:ae.login,name:ae.name||ae.login,avatar:ae.avatar_url,url:"https://github.com/"+ae.login,info:ae},ee.fire(this.mavo.element,"mavo:login",{backend:this})})},getURL:function(ae=this.path,re){var ne=`${this.username}/${this.repo}`;return ae=ae.replace(/ /g,"%20"),this.request(`repos/${ne}/pages`,{},"GET",{headers:{Accept:"application/vnd.github.mister-fantastic-preview+json"}}).then(oe=>oe.html_url+ae).catch(()=>{return re?`https://cdn.rawgit.com/${ne}/${re}/${ae}`:`https://rawgit.com/${ne}/${this.branch}/${ae}`})},static:{apiDomain:"https://api.github.com/",oAuth:"https://github.com/login/oauth/authorize",test:function(ae){return ae=new URL(ae,Mavo.base),/\bgithub.com|raw.githubusercontent.com/.test(ae.host)},parseURL:function(ae){var re={};ae=new URL(ae,Mavo.base);var ne=ae.pathname.slice(1).split("/");if(re.username=ne.shift(),re.repo=ne.shift(),/raw.githubusercontent.com$/.test(ae.host))re.branch=ne.shift();else{if(/api.github.com$/.test(ae.host))return{};/github.com$/.test(ae.host)&&"blob"==ne[0]&&(ne.shift(),re.branch=ne.shift())}return re.path=ne.join("/"),re},btoa:ae=>btoa(unescape(encodeURIComponent(ae))),atob:ae=>decodeURIComponent(escape(window.atob(ae)))}}))}(Bliss);
//# sourceMappingURL=maps/mavo.min.js.map
